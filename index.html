<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Respira">
<meta name="theme-color" content="#080705">
<title>Respira</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
/* ── DARK (default) ── */
:root {
  --bg:      #080705;
  --bg2:     #0f0e0b;
  --card:    rgba(255,248,235,0.035);
  --border:  rgba(255,248,235,0.08);
  --text:    #f0ebe2;
  --muted:   rgba(240,235,226,0.40);
  --muted2:  rgba(240,235,226,0.18);
  --amber:   #c8a26a;
  --sage:    #7a9e7e;
  --rose:    #b07a8a;
  --stone:   #9a8a78;
  --gold-ln: rgba(200,162,106,0.18);
  --noise-op: 0.025;
  --fd: 'Cormorant Garamond', Georgia, serif;
  --fm: 'DM Mono', 'Courier New', monospace;
  --range-track: rgba(255,255,255,0.12);
  --bar-bg: rgba(255,255,255,0.03);
  --prog-bg: rgba(255,255,255,0.06);
}
:root.light {
  --bg:      #f5f0e8;
  --bg2:     #ede7da;
  --card:    rgba(60,40,10,0.04);
  --border:  rgba(60,40,10,0.10);
  --text:    #1e1a14;
  --muted:   rgba(30,26,20,0.45);
  --muted2:  rgba(30,26,20,0.25);
  --amber:   #9a6c32;
  --sage:    #4a7a50;
  --rose:    #884060;
  --stone:   #6a5a48;
  --gold-ln: rgba(154,108,50,0.20);
  --noise-op: 0.015;
  --range-track: rgba(0,0,0,0.10);
  --bar-bg: rgba(0,0,0,0.04);
  --prog-bg: rgba(0,0,0,0.08);
}

*,*::before,*::after { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
html, body { height:100%; width:100%; }
body {
  background: #080705; background: var(--bg);
  color: #f0ebe2; color: var(--text);
  font-family: 'Cormorant Garamond', Georgia, serif; font-family: var(--fd);
  overflow: hidden; user-select: none; -webkit-user-select: none;
  position: fixed; top:0; left:0; right:0; bottom:0;
}
body::before {
  content:''; position:fixed; top:0; left:0; right:0; bottom:0; z-index:11; pointer-events:none;
  opacity:0.025; opacity:var(--noise-op);
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-size:180px;
}

.screen {
  position:fixed; top:0; left:0; right:0; bottom:0;
  display:flex; flex-direction:column; z-index:10;
  transition:opacity .5s cubic-bezier(.4,0,.2,1), transform .5s cubic-bezier(.4,0,.2,1);
  overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch;
  background:#080705; background:var(--bg);
}
.screen.hidden { opacity:0; pointer-events:none; transform:translateY(22px); }

/* ── SETUP ── */
#setup { padding:max(env(safe-area-inset-top,0px),20px) 0 max(env(safe-area-inset-bottom,0px),32px); }
.app-header {
  display:flex; flex-direction:column; align-items:stretch;
  padding:20px 24px 18px; flex-shrink:0; position:relative; gap:14px;
}
.app-header::after { content:''; position:absolute; bottom:0; left:24px; right:24px; height:1px; background:rgba(200,162,106,0.18); background:var(--gold-ln); }

/* Top row: title left, Inizia right */
.app-header-top {
  display:flex; flex-direction:row; align-items:stretch;
  justify-content:space-between; gap:12px;
}
.app-title-wrap { display:flex; flex-direction:column; justify-content:space-between; gap:0; }
.app-title { font-size:clamp(40px,10.5vw,54px); font-weight:300; letter-spacing:.14em; line-height:1; margin-bottom:6px; }
.app-sub { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:8.5px; letter-spacing:.32em; color:rgba(240,235,226,0.40); color:var(--muted); text-transform:uppercase; }
.app-credit { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:8.5px; letter-spacing:.22em; color:#f0ebe2; color:var(--text); text-transform:lowercase; margin-top:2px; }

/* Inizia button — stretches to fill title-wrap height */
.start-btn-header {
  flex-shrink:0; padding:0 40px; border:none; border-radius:14px;
  font-family:'Cormorant Garamond',Georgia,serif; font-family:var(--fd);
  font-size:19px; font-weight:400; letter-spacing:.12em; color:#1a1208;
  cursor:pointer; position:relative; overflow:hidden; -webkit-appearance:none;
  transition:transform .15s, box-shadow .2s;
  background:linear-gradient(135deg,#c8a26a 0%,#d4b47c 50%,#b89058 100%);
  box-shadow:0 4px 22px rgba(200,162,106,.32), 0 2px 8px rgba(0,0,0,.38);
  white-space:nowrap; display:flex; flex-direction:column;
  align-items:center; justify-content:center; gap:2px;
  align-self:stretch;
}
.start-btn-header:active { transform:scale(.96); }
.start-btn-header::after { content:''; position:absolute; inset:0; background:linear-gradient(180deg,rgba(255,255,255,.18) 0%,transparent 55%); pointer-events:none; }
.start-btn-lbl { font-size:19px; font-weight:400; letter-spacing:.12em; line-height:1; }
.start-btn-arrow { font-size:22px; line-height:1; opacity:.85; }

/* Bottom action bar */
.app-header-actions {
  display:flex; align-items:stretch; gap:7px;
}

/* Shared style for all header utility buttons */
.hdr-btn {
  flex:1; min-width:0; border-radius:12px;
  border:1px solid rgba(255,248,235,0.11);
  background:rgba(255,248,235,0.04);
  color:rgba(240,235,226,0.55);
  font-family:'DM Mono','Courier New',monospace;
  font-size:8.5px; letter-spacing:.16em; text-transform:uppercase;
  cursor:pointer; -webkit-appearance:none; outline:none;
  transition:all .22s; display:flex; flex-direction:column;
  align-items:center; justify-content:center; gap:2px;
  padding:9px 10px; text-align:center; line-height:1.35; white-space:normal;
}
.hdr-btn:active { background:rgba(200,162,106,.11); border-color:rgba(200,162,106,.35); color:#c8a26a; transform:scale(.95); }
:root.light .hdr-btn { border-color:rgba(30,26,20,0.13); background:rgba(30,26,20,0.04); color:rgba(30,26,20,0.50); }
:root.light .hdr-btn:active { background:rgba(154,108,50,.10); border-color:rgba(154,108,50,.35); color:#9a6c32; }
/* Theme button keeps amber tint */
.hdr-btn.theme { border-color:rgba(200,162,106,.22); background:rgba(200,162,106,.06); color:#c8a26a; }
:root.light .hdr-btn.theme { border-color:rgba(154,108,50,.26); background:rgba(154,108,50,.07); color:#9a6c32; }
/* Icon inside hdr-btn */
.hdr-btn-icon { font-size:14px; line-height:1; letter-spacing:0; }
.hdr-btn-lbl { font-size:8px; letter-spacing:.16em; line-height:1.3; }
.sec { padding:18px 24px 0; flex-shrink:0; }
.sec-lbl {
  font-family:'DM Mono','Courier New',monospace; font-family:var(--fm);
  font-size:8.5px; letter-spacing:.35em; color:rgba(240,235,226,0.18); color:var(--muted2);
  text-transform:uppercase; margin-bottom:12px; display:flex; align-items:center; gap:10px;
}
.sec-lbl::after { content:''; flex:1; height:1px; background:rgba(255,248,235,0.08); background:var(--border); }

/* ── PATTERN CARDS ── */
.pattern-grid { display:flex; flex-direction:column; gap:7px; }
.pattern-card {
  background:rgba(255,248,235,0.035); background:var(--card);
  border:1px solid rgba(255,248,235,0.08); border:1px solid var(--border);
  border-radius:13px; padding:12px 15px; cursor:pointer;
  display:flex; align-items:center; gap:13px;
  transition:all .25s cubic-bezier(.4,0,.2,1);
}
.pattern-card:active { transform:scale(.985); }
.pattern-card.active { border-color:rgba(200,162,106,.7) !important; background:rgba(200,162,106,.14) !important; box-shadow:0 0 0 1px rgba(200,162,106,.3), inset 0 0 20px rgba(200,162,106,.05); }
.pattern-card.active[data-id="deep"] { border-color:rgba(122,158,126,.7) !important; background:rgba(122,158,126,.14) !important; box-shadow:0 0 0 1px rgba(122,158,126,.3), inset 0 0 20px rgba(122,158,126,.05); }
.pattern-card.active[data-id="slow"] { border-color:rgba(176,122,138,.7) !important; background:rgba(176,122,138,.14) !important; box-shadow:0 0 0 1px rgba(176,122,138,.3), inset 0 0 20px rgba(176,122,138,.05); }
.pm { width:3px; height:34px; border-radius:2px; flex-shrink:0; background:#9a8a78; background:var(--stone); transition:background .3s; }
.pattern-card.active[data-id="box"]  .pm { background:#c8a26a; background:var(--amber); box-shadow:0 0 10px rgba(200,162,106,.5); }
.pattern-card.active[data-id="deep"] .pm { background:#7a9e7e; background:var(--sage); box-shadow:0 0 10px rgba(122,158,126,.5); }
.pattern-card.active[data-id="slow"] .pm { background:#b07a8a; background:var(--rose); box-shadow:0 0 10px rgba(176,122,138,.5); }
.pi { flex:1; }
.pn { font-size:16px; font-weight:400; color:#f0ebe2; color:var(--text); letter-spacing:.02em; }
.pd { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:9.5px; color:rgba(240,235,226,0.40); color:var(--muted); margin-top:3px; }
.ph-chip { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:9.5px; padding:3px 8px; border-radius:20px; background:rgba(255,248,235,0.035); background:var(--card); border:1px solid rgba(255,248,235,0.08); border:1px solid var(--border); color:rgba(240,235,226,0.40); color:var(--muted); flex-shrink:0; }

/* ── DURATION ── */
.dur-row { display:flex; gap:7px; }
.dur-pill { flex:1; background:rgba(255,248,235,0.035); background:var(--card); border:1px solid rgba(255,248,235,0.08); border:1px solid var(--border); border-radius:11px; padding:11px 4px; cursor:pointer; text-align:center; transition:all .2s; }
.dur-pill:active { transform:scale(.95); }
.dur-pill.active { border-color:rgba(200,162,106,.5); background:rgba(200,162,106,.08); }
.dn { font-size:19px; font-weight:300; display:block; line-height:1; }
.dl { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:7.5px; color:rgba(240,235,226,0.40); color:var(--muted); letter-spacing:.1em; }

/* ── TRACK CARDS ── */
.track-list { display:flex; flex-direction:column; gap:7px; }
.track-card {
  background:rgba(255,248,235,0.035); background:var(--card);
  border:1px solid rgba(255,248,235,0.08); border:1px solid var(--border);
  border-radius:13px; padding:13px 15px; cursor:pointer; display:flex; align-items:center; gap:13px;
  transition:all .25s cubic-bezier(.4,0,.2,1);
}
.track-card:active { transform:scale(.985); }
.track-card.active { border-color:rgba(200,162,106,.45); background:rgba(200,162,106,.07); }
/* Real MP3 track active states */
.track-card.active[data-tid="serenity"]     { border-color:rgba(122,158,122,.5); background:rgba(122,158,122,.07); }
.track-card.active[data-tid="subterranean"] { border-color:rgba(122,138,180,.5); background:rgba(122,138,180,.07); }
/* Recommendation glow */
.track-card.rec-active { border-color:rgba(200,162,106,.35) !important; box-shadow:0 0 18px rgba(200,162,106,.08); }
.track-card.rec-active[data-tid="serenity"]     { border-color:rgba(122,158,122,.35) !important; box-shadow:0 0 18px rgba(122,158,122,.08); }
.track-card.rec-active[data-tid="subterranean"] { border-color:rgba(122,138,180,.35) !important; box-shadow:0 0 18px rgba(122,138,180,.08); }
.tk-icon { width:42px; height:42px; border-radius:10px; flex-shrink:0; font-size:18px; background:rgba(255,248,235,0.035); background:var(--card); border:1px solid rgba(255,248,235,0.08); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; transition:all .3s; }
.track-card.active .tk-icon { background:rgba(200,162,106,.1); border-color:rgba(200,162,106,.3); }
.track-card.active[data-tid="serenity"] .tk-icon,
.track-card.active[data-tid="subterranean"] .tk-icon { background:rgba(200,162,106,.08); border-color:rgba(200,162,106,.25); }
/* Premium real-track icon style */
.tk-icon.tk-real { font-size:13px; font-family:'DM Mono','Courier New',monospace; letter-spacing:-.02em; }
.tk-info { flex:1; min-width:0; }
.tk-name { font-size:15px; font-weight:400; color:#f0ebe2; color:var(--text); }
.tk-desc { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:8.5px; color:rgba(240,235,226,0.40); color:var(--muted); margin-top:3px; letter-spacing:.03em; line-height:1.5; }
.tk-badge { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:8px; color:rgba(240,235,226,0.18); color:var(--muted2); letter-spacing:.06em; padding:2px 7px; border:1px solid rgba(255,248,235,0.08); border:1px solid var(--border); border-radius:8px; flex-shrink:0; }
.track-card.active .tk-badge { border-color:rgba(200,162,106,.3); color:#c8a26a; color:var(--amber); }
/* Premium badge with real marker */
.tk-badge.premium { color:rgba(200,162,106,.7); border-color:rgba(200,162,106,.25); background:rgba(200,162,106,.04); }
.track-card.active .tk-badge.premium { color:#c8a26a; border-color:rgba(200,162,106,.5); background:rgba(200,162,106,.1); }
/* Recommendation chip on track cards */
.tk-rec-chip {
  font-family:'DM Mono','Courier New',monospace; font-size:7.5px; letter-spacing:.12em;
  padding:2px 7px; border-radius:8px; border:1px solid transparent;
  white-space:nowrap; display:none; margin-top:5px;
  background:rgba(200,162,106,.08); color:rgba(200,162,106,.7); border-color:rgba(200,162,106,.2);
}
.track-card.rec-active .tk-rec-chip { display:inline-block; }
.track-card.rec-active[data-tid="serenity"] .tk-rec-chip {
  background:rgba(122,158,122,.08); color:rgba(122,158,122,.8); border-color:rgba(122,158,122,.2);
}
.track-card.rec-active[data-tid="subterranean"] .tk-rec-chip {
  background:rgba(122,138,180,.08); color:rgba(122,138,180,.8); border-color:rgba(122,138,180,.2);
}
/* Loading state for MP3 tracks */
.track-card.loading .tk-icon { opacity:.5; animation:pulse-tk 1.2s infinite; }
@keyframes pulse-tk { 0%,100%{opacity:.5;} 50%{opacity:.9;} }

.attr { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:8.5px; color:rgba(240,235,226,0.18); color:var(--muted2); letter-spacing:.1em; text-align:center; padding:9px 0 0; }
.attr-divider { display:flex; align-items:center; gap:8px; padding:8px 0 0; }
.attr-divider::before,.attr-divider::after { content:''; flex:1; height:1px; background:rgba(255,248,235,0.05); background:var(--border); opacity:.5; }

/* ── BINAURAL SECTION ── */
.binaural-rec {
  display:flex; align-items:center; gap:8px; margin-bottom:12px;
  padding:10px 13px; border-radius:11px;
  background:rgba(200,162,106,.06); border:1px solid rgba(200,162,106,.18);
  transition:all .4s cubic-bezier(.4,0,.2,1);
}
.binaural-rec.hidden { display:none; }
.binaural-rec-icon { font-family:'DM Mono','Courier New',monospace; font-size:11px; color:#c8a26a; flex-shrink:0; }
.binaural-rec-text { font-family:'DM Mono','Courier New',monospace; font-size:8.5px; color:rgba(200,162,106,.9); letter-spacing:.08em; }
.binaural-rec.rec-theta { background:rgba(122,122,180,.06); border-color:rgba(122,122,180,.18); }
.binaural-rec.rec-theta .binaural-rec-icon { color:#9a9adb; }
.binaural-rec.rec-theta .binaural-rec-text { color:rgba(154,154,219,.9); }

.binaural-grid { display:flex; flex-direction:column; gap:7px; }
.binaural-card {
  background:rgba(255,248,235,0.035); background:var(--card);
  border:1px solid rgba(255,248,235,0.08); border:1px solid var(--border);
  border-radius:13px; padding:13px 15px; cursor:pointer;
  display:flex; align-items:center; gap:13px;
  transition:all .25s cubic-bezier(.4,0,.2,1);
}
.binaural-card:active { transform:scale(.985); }
.binaural-card.active { border-color:rgba(200,162,106,.45); background:rgba(200,162,106,.07); }
.binaural-card.active[data-bid="theta"] { border-color:rgba(122,122,180,.45); background:rgba(122,122,180,.07); }
.binaural-card.rec-glow { border-color:rgba(200,162,106,.3); box-shadow:0 0 16px rgba(200,162,106,.07); }
.binaural-card.rec-glow[data-bid="theta"] { border-color:rgba(122,122,180,.3); box-shadow:0 0 16px rgba(122,122,180,.07); }
.bq-accent { width:3px; height:32px; border-radius:2px; flex-shrink:0; background:#9a8a78; background:var(--stone); transition:background .3s; }
.binaural-card.active[data-bid="none"]  .bq-accent { background:rgba(240,235,226,.3); }
.binaural-card.active[data-bid="alpha"] .bq-accent { background:#c8a26a; box-shadow:0 0 8px rgba(200,162,106,.5); }
.binaural-card.active[data-bid="theta"] .bq-accent { background:#9a9adb; box-shadow:0 0 8px rgba(154,154,219,.5); }
.bq-info { flex:1; min-width:0; }
.bq-name { font-size:15px; font-weight:400; color:#f0ebe2; color:var(--text); letter-spacing:.02em; }
.bq-hz  { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:9px; color:rgba(240,235,226,0.40); color:var(--muted); letter-spacing:.05em; margin-bottom:3px; }
.bq-desc { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:8.5px; color:rgba(240,235,226,0.40); color:var(--muted); margin-top:3px; letter-spacing:.03em; line-height:1.5; }
.bq-chip { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:8px; padding:2px 8px; border-radius:20px; border:1px solid rgba(255,248,235,0.08); border:1px solid var(--border); color:rgba(240,235,226,0.18); color:var(--muted2); flex-shrink:0; letter-spacing:.06em; }
.binaural-card.active[data-bid="alpha"] .bq-chip { color:#c8a26a; border-color:rgba(200,162,106,.3); }
.binaural-card.active[data-bid="theta"] .bq-chip { color:#9a9adb; border-color:rgba(154,154,219,.3); }
.binaural-note {
  margin-top:10px; font-family:'DM Mono','Courier New',monospace; font-family:var(--fm);
  font-size:8px; color:rgba(240,235,226,0.18); color:var(--muted2); letter-spacing:.1em;
  text-align:center; display:flex; align-items:center; justify-content:center; gap:6px;
}

/* ── PREVIEW BARS ── */
.preview-box { display:flex; gap:8px; align-items:flex-end; padding:13px; border:1px solid rgba(255,248,235,0.08); border:1px solid var(--border); border-radius:14px; background:rgba(255,248,235,0.035); background:var(--card); height:80px; overflow:hidden; }
.prev-col { flex:1; display:flex; flex-direction:column; align-items:center; height:100%; gap:5px; }
.prev-track { flex:1; width:100%; border-radius:3px; background:rgba(255,255,255,0.03); background:var(--bar-bg); border:1px solid rgba(255,248,235,0.08); border:1px solid var(--border); position:relative; overflow:hidden; }
.prev-fill { position:absolute; bottom:0; left:0; right:0; height:0%; border-radius:2px; transition:height .85s cubic-bezier(.4,0,.2,1); }
.prev-fill.fill-top { top:0; bottom:auto; }
.prev-fill.fill-ltr { bottom:0; left:0; top:0; right:auto; height:100% !important; width:0%; transition:width .85s cubic-bezier(.4,0,.2,1); }
.prev-num { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:13px; font-weight:400; color:rgba(240,235,226,0.40); color:var(--muted); letter-spacing:.04em; flex-shrink:0; line-height:1; }
.prev-num.active-num { color:#f0ebe2; color:var(--text); }
.prev-name { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:7px; letter-spacing:.12em; color:rgba(240,235,226,0.40); color:var(--muted); text-transform:uppercase; flex-shrink:0; white-space:nowrap; }
.prev-count-row { display:flex; align-items:baseline; gap:2px; flex-shrink:0; }
.prev-sec-lbl { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:6px; letter-spacing:.1em; color:rgba(240,235,226,0.18); color:var(--muted2); text-transform:uppercase; }

/* ── SAVE / VOL ── */
.save-btn {
  padding:9px 12px; border:1px solid rgba(200,162,106,.22); border-radius:12px;
  background:rgba(200,162,106,.05); color:#c8a26a; color:var(--amber);
  font-family:'DM Mono','Courier New',monospace; font-family:var(--fm);
  font-size:8.5px; letter-spacing:.16em; text-transform:uppercase;
  cursor:pointer; -webkit-appearance:none; transition:all .2s;
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px;
  text-align:center; line-height:1.35;
}
.save-btn:active { background:rgba(200,162,106,.12); transform:scale(.98); }
.save-btn.saved { border-color:rgba(122,158,126,.35); color:#7a9e7e; color:var(--sage); background:rgba(122,158,126,.06); }
.save-icon { font-size:12px; }
.vol-wrap { display:flex; align-items:center; gap:12px; }
.vi { font-size:13px; color:rgba(240,235,226,0.40); color:var(--muted); }
input[type=range] { flex:1; -webkit-appearance:none; appearance:none; height:2px; background:rgba(255,255,255,0.12); background:var(--range-track); border-radius:2px; outline:none; }
input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:18px; height:18px; border-radius:50%; background:#c8a26a; background:var(--amber); cursor:pointer; box-shadow:0 0 10px rgba(200,162,106,.45); }
.pwa-hint { text-align:center; font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:8.5px; color:rgba(240,235,226,0.18); color:var(--muted2); letter-spacing:.12em; padding:11px 24px 0; flex-shrink:0; }

/* ── SESSION ── */
#session { align-items:center; justify-content:space-between; padding:max(env(safe-area-inset-top,0px),24px) 28px max(env(safe-area-inset-bottom,0px),24px); overflow:hidden; }
.orbs { position:fixed; top:0; left:0; right:0; bottom:0; pointer-events:none; z-index:0; }
.orb { position:absolute; border-radius:50%; filter:blur(90px); transition:background 3s ease; }
.orb1 { width:420px; height:420px; top:-140px; right:-140px; opacity:.10; }
.orb2 { width:300px; height:300px; bottom:-90px; left:-110px; opacity:.07; }
.sess-hdr { display:flex; justify-content:space-between; align-items:flex-start; width:100%; z-index:1; flex-shrink:0; margin-bottom:10px; }
.close-btn { width:40px; height:40px; border-radius:50%; border:1px solid rgba(255,248,235,0.08); border:1px solid var(--border); background:rgba(255,248,235,0.035); background:var(--card); color:rgba(240,235,226,0.40); color:var(--muted); font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; -webkit-backdrop-filter:blur(10px); backdrop-filter:blur(10px); -webkit-appearance:none; }
.sess-meta { text-align:right; }
.spl { font-size:13px; font-weight:300; color:#f0ebe2; color:var(--text); letter-spacing:.04em; }
.shl { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:9px; color:rgba(240,235,226,0.40); color:var(--muted); letter-spacing:.12em; margin-top:3px; }
.ticker { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:9px; color:rgba(240,235,226,0.40); color:var(--muted); z-index:1; flex-shrink:0; display:flex; align-items:center; gap:8px; width:100%; margin-bottom:6px; }
.tdot { width:6px; height:6px; border-radius:50%; flex-shrink:0; background:#c8a26a; background:var(--amber); animation:pdot 2.5s infinite; }
.ttxt { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
@keyframes pdot { 0%,100%{opacity:1;} 50%{opacity:.3;} }
.phase-info { z-index:1; flex-shrink:0; text-align:center; width:100%; margin-bottom:8px; }
.phase-lbl { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:clamp(14px,4vw,19px); letter-spacing:.44em; text-transform:uppercase; color:rgba(240,235,226,0.40); color:var(--muted); transition:color .6s ease; }
.countdown-row { display:flex; align-items:flex-end; justify-content:center; gap:8px; margin-top:4px; }
.countdown { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:clamp(110px,30vw,180px); font-weight:400; line-height:1; letter-spacing:0; font-variant-numeric:tabular-nums lining-nums; -webkit-font-feature-settings:"tnum" 1,"lnum" 1; font-feature-settings:"tnum" 1,"lnum" 1; transition:color .6s ease; display:inline-block; }
.cunit { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:11px; letter-spacing:.35em; color:rgba(240,235,226,0.40); color:var(--muted); padding-bottom:12px; white-space:nowrap; }
.sess-pattern-desc { z-index:1; flex-shrink:0; width:100%; margin-bottom:8px; padding:13px 16px; border:1px solid rgba(255,248,235,.07); border-radius:14px; background:linear-gradient(135deg,rgba(255,248,235,0.035) 0%,rgba(200,162,106,.06) 100%); position:relative; overflow:hidden; }
.sess-pattern-desc::before { content:''; position:absolute; left:0; top:0; bottom:0; width:2px; background:linear-gradient(180deg,#c8a26a 0%,transparent 100%); opacity:.5; }
.sess-pattern-name { font-size:16px; font-weight:400; color:#f0ebe2; color:var(--text); letter-spacing:.04em; margin-bottom:5px; }
.sess-pattern-text { font-size:12px; font-weight:300; font-style:italic; color:rgba(240,235,226,0.40); color:var(--muted); line-height:1.6; }
.sess-pattern-steps { display:flex; gap:5px; margin-top:8px; flex-wrap:wrap; }
.sess-pattern-step { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:7.5px; padding:3px 8px; border-radius:20px; background:rgba(255,255,255,0.03); background:var(--bar-bg); border:1px solid rgba(255,248,235,0.08); border:1px solid var(--border); color:rgba(240,235,226,0.18); color:var(--muted2); letter-spacing:.07em; }
.breath-wrap { z-index:1; flex-shrink:0; width:100%; margin-bottom:12px; }
.breath-bars { display:flex; gap:9px; width:100%; height:clamp(60px,14vw,96px); }
.bar-col { flex:1; display:flex; flex-direction:column; align-items:center; height:100%; gap:6px; }
.bar-track { flex:1; width:100%; position:relative; overflow:hidden; border-radius:5px 5px 4px 4px; background:rgba(255,255,255,0.03); background:var(--bar-bg); border:1px solid rgba(255,248,235,0.08); border:1px solid var(--border); transition:border-color .5s; }
.bar-track.cur { border-color:rgba(128,100,60,.22); }
.bar-fill { position:absolute; bottom:0; left:0; right:0; height:0%; border-radius:4px 4px 3px 3px; }
.bar-fill.top-fill { top:0; bottom:auto; }
.bar-fill.ltr-fill { top:0; bottom:0; left:0; right:auto; height:100%; width:0%; }
.bar-lbl { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:7.5px; letter-spacing:.18em; text-transform:uppercase; color:rgba(240,235,226,0.40); color:var(--muted); transition:color .4s; flex-shrink:0; white-space:nowrap; }
.bar-col.cur .bar-lbl { color:#f0ebe2; color:var(--text); }
.sess-vol { display:flex; align-items:center; gap:12px; z-index:1; flex-shrink:0; width:100%; margin-bottom:10px; }
.prog-area { width:100%; z-index:1; flex-shrink:0; }
.prog-track { width:100%; height:2px; background:rgba(255,255,255,0.06); background:var(--prog-bg); border-radius:2px; overflow:hidden; margin-bottom:8px; }
.prog-fill { height:100%; border-radius:2px; width:0%; transition:width 1s linear; background:#c8a26a; background:var(--amber); }
.prog-time { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:10px; color:rgba(240,235,226,0.40); color:var(--muted); letter-spacing:.1em; text-align:center; }

/* ── END ── */
#end { align-items:center; justify-content:center; text-align:center; gap:26px; padding:40px 32px max(env(safe-area-inset-bottom,0px),32px); }
.end-mark { font-size:52px; color:#c8a26a; color:var(--amber); text-shadow:0 0 40px rgba(200,162,106,.45); }
.end-title { font-size:38px; font-weight:300; letter-spacing:.06em; line-height:1.15; }
.end-div { width:38px; height:1px; background:rgba(200,162,106,0.18); background:var(--gold-ln); }
.end-sub { font-size:14px; font-weight:300; color:rgba(240,235,226,0.40); color:var(--muted); line-height:1.75; max-width:260px; font-style:italic; }
.end-stats { display:flex; gap:28px; padding:20px 32px; border:1px solid rgba(255,248,235,0.08); border:1px solid var(--border); border-radius:17px; background:rgba(255,248,235,0.035); background:var(--card); }
.stat { display:flex; flex-direction:column; align-items:center; gap:4px; }
.stat-val { font-size:26px; font-weight:300; color:#c8a26a; color:var(--amber); font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); }
.stat-lbl { font-family:'DM Mono','Courier New',monospace; font-family:var(--fm); font-size:8px; letter-spacing:.25em; color:rgba(240,235,226,0.40); color:var(--muted); text-transform:uppercase; }
.again-btn { width:100%; padding:16px; border:1px solid rgba(255,248,235,0.08); border:1px solid var(--border); border-radius:13px; background:rgba(255,248,235,0.035); background:var(--card); color:#f0ebe2; color:var(--text); font-family:'Cormorant Garamond',Georgia,serif; font-family:var(--fd); font-size:16px; font-weight:300; letter-spacing:.12em; cursor:pointer; -webkit-appearance:none; transition:background .2s, border-color .2s; }
.again-btn:active { background:rgba(200,162,106,.08); border-color:rgba(200,162,106,.3); }

/* ── GEAR ── */
.gear-btn {
  width:36px; height:36px; border-radius:50%;
  border:1px solid rgba(255,248,235,0.08); border:1px solid var(--border);
  background:rgba(255,248,235,0.035); background:var(--card);
  color:rgba(240,235,226,0.40); color:var(--muted); font-size:16px;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  -webkit-appearance:none; transition:all .2s; flex-shrink:0;
}
.gear-btn:active { transform:rotate(45deg) scale(.92); }

/* ── OVERLAY PANELS (Safari-proof) ── */
.overlay-panel {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:#080705; background:var(--bg); z-index:2000;
  display:flex; flex-direction:column; overflow:hidden;
  -webkit-transform:translateZ(0); transform:translateZ(0);
  -webkit-backface-visibility:hidden; backface-visibility:hidden;
  transition:opacity .3s cubic-bezier(.4,0,.2,1), transform .3s cubic-bezier(.4,0,.2,1);
}
.overlay-panel.hidden { opacity:0; pointer-events:none; transform:translateZ(0) translateY(20px); }
.panel-hdr { display:flex; justify-content:space-between; align-items:center; padding:max(env(safe-area-inset-top,0px),20px) 24px 18px; border-bottom:1px solid rgba(255,255,255,0.07); flex-shrink:0; }
.panel-title { font-family:'DM Mono','Courier New',monospace; font-size:10px; letter-spacing:.4em; color:rgba(240,235,226,0.40); text-transform:uppercase; }
.panel-close { font-family:'DM Mono','Courier New',monospace; font-size:10px; color:rgba(240,235,226,0.60); cursor:pointer; padding:6px 14px; border:1px solid rgba(255,255,255,0.10); border-radius:8px; background:rgba(255,255,255,0.05); -webkit-appearance:none; min-width:60px; min-height:36px; display:flex; align-items:center; justify-content:center; }
.panel-close:active { background:rgba(255,255,255,0.10); }
.panel-scroll { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:20px 24px; }
.panel-section { margin-bottom:28px; }
.panel-section-title { font-family:'DM Mono','Courier New',monospace; font-size:8px; letter-spacing:.38em; color:rgba(240,235,226,0.30); text-transform:uppercase; margin-bottom:14px; display:flex; align-items:center; gap:10px; }
.panel-section-title::after { content:''; flex:1; height:1px; background:rgba(255,255,255,0.07); }
.toggle-row { display:flex; justify-content:space-between; align-items:center; padding:14px 0; border-bottom:1px solid rgba(255,255,255,0.06); }
.toggle-row:last-child { border-bottom:none; }
.toggle-info { flex:1; min-width:0; padding-right:16px; }
.toggle-label { font-size:15px; font-weight:400; color:#f0ebe2; letter-spacing:.02em; }
.toggle-desc { font-family:'DM Mono','Courier New',monospace; font-size:8.5px; color:rgba(240,235,226,0.40); margin-top:3px; letter-spacing:.03em; line-height:1.5; }

/* TOGGLE SWITCH (Safari-proof: real <span> knob) */
.sw { width:51px; height:31px; border-radius:16px; background:rgba(120,120,128,0.32); position:relative; cursor:pointer; border:none; outline:none; -webkit-appearance:none; appearance:none; transition:background .25s; display:inline-block; flex-shrink:0; vertical-align:middle; padding:0; }
.sw.on { background:#c8a26a; }
.sw.on.sage { background:#7a9e7e; }
.sw-knob { position:absolute; top:2px; left:2px; width:27px; height:27px; border-radius:50%; background:#ffffff; box-shadow:0 2px 6px rgba(0,0,0,0.35); transition:transform .25s cubic-bezier(.4,0,.2,1); pointer-events:none; display:block; }
.sw.on .sw-knob { transform:translateX(20px); }

.audio-note { background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.07); border-radius:12px; padding:13px 15px; margin-top:12px; }
.audio-note-title { font-family:'DM Mono','Courier New',monospace; font-size:8px; letter-spacing:.3em; color:#c8a26a; margin-bottom:6px; }
.audio-note-text { font-family:'DM Mono','Courier New',monospace; font-size:8.5px; color:rgba(240,235,226,0.40); line-height:1.7; }

/* Debug */
.debug-section { margin-bottom:16px; }
.debug-section-title { font-family:'DM Mono','Courier New',monospace; font-size:8px; letter-spacing:.3em; color:rgba(240,235,226,0.30); text-transform:uppercase; margin-bottom:8px; }
.debug-row { display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid rgba(255,255,255,.04); }
.debug-key { font-family:'DM Mono','Courier New',monospace; font-size:9.5px; color:rgba(240,235,226,0.40); }
.debug-val { font-family:'DM Mono','Courier New',monospace; font-size:9.5px; color:#f0ebe2; word-break:break-all; text-align:right; max-width:65%; }
.debug-val.ok{color:#7a9e7e;} .debug-val.err{color:#e07a7a;} .debug-val.warn{color:#c8a26a;}
.debug-log { background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.07); border-radius:10px; padding:12px; font-family:'DM Mono','Courier New',monospace; font-size:9px; color:rgba(240,235,226,0.40); line-height:1.8; white-space:pre-wrap; word-break:break-all; max-height:180px; overflow-y:auto; -webkit-overflow-scrolling:touch; }
.debug-actions { padding:12px 24px max(env(safe-area-inset-bottom,0px),12px); flex-shrink:0; display:flex; gap:8px; }
.debug-btn { flex:1; padding:12px; font-family:'DM Mono','Courier New',monospace; font-size:9px; letter-spacing:.15em; text-transform:uppercase; color:rgba(240,235,226,0.40); border:1px solid rgba(255,255,255,0.08); border-radius:10px; background:rgba(255,255,255,0.03); cursor:pointer; -webkit-appearance:none; }
.debug-btn.primary { color:#c8a26a; border-color:rgba(200,162,106,.3); }
.debug-toggle { position:fixed; bottom:max(env(safe-area-inset-bottom,0px),14px); right:18px; z-index:1500; font-family:'DM Mono','Courier New',monospace; font-size:8.5px; letter-spacing:.2em; color:rgba(240,235,226,0.30); background:#080705; border:1px solid rgba(255,255,255,.07); padding:6px 14px; border-radius:20px; cursor:pointer; -webkit-appearance:none; transition:all .2s; }
.debug-toggle.has-error { color:#e07a7a; border-color:rgba(224,122,122,.25); }

/* Custom track */
.custom-track-area { margin-top:14px; border:1px solid rgba(255,255,255,0.07); border-radius:14px; overflow:hidden; transition:opacity .3s, border-color .3s; }
.custom-track-area.disabled { opacity:.38; pointer-events:none; }
#customFileInput { position:absolute; width:1px; height:1px; opacity:0; pointer-events:none; }
.ct-empty { padding:16px; display:flex; flex-direction:column; gap:12px; background:rgba(255,255,255,0.03); border-radius:14px; }
.ct-pick-btn { display:flex; align-items:center; gap:12px; padding:14px 16px; border-radius:11px; border:1.5px solid rgba(255,255,255,0.10); background:rgba(255,255,255,.06); cursor:pointer; transition:all .2s; -webkit-tap-highlight-color:transparent; text-decoration:none; }
.ct-pick-btn:active { background:rgba(200,162,106,.08); border-color:rgba(200,162,106,.5); transform:scale(.98); }
.ct-pick-icon { font-size:22px; flex-shrink:0; }
.ct-pick-main { font-family:'Cormorant Garamond',Georgia,serif; font-size:15px; font-weight:400; color:#f0ebe2; letter-spacing:.02em; line-height:1.2; display:block; }
.ct-pick-sub { font-family:'DM Mono','Courier New',monospace; font-size:8px; letter-spacing:.15em; color:rgba(240,235,226,0.40); text-transform:uppercase; display:block; margin-top:2px; }
.ct-or { display:flex; align-items:center; gap:10px; font-family:'DM Mono','Courier New',monospace; font-size:8px; letter-spacing:.25em; color:rgba(240,235,226,0.30); text-transform:uppercase; }
.ct-or::before,.ct-or::after { content:''; flex:1; height:1px; background:rgba(255,255,255,0.07); }
.ct-url-row { display:flex; gap:8px; align-items:stretch; }
.ct-url-input { flex:1; min-width:0; min-height:44px; font-family:'DM Mono','Courier New',monospace; font-size:11px; letter-spacing:.02em; color:#f0ebe2; background:#1a1810; border:1.5px solid #3a3428; border-radius:10px; padding:11px 12px; outline:none; -webkit-appearance:none; display:block; width:100%; transition:border-color .2s, background .2s; }
.ct-url-input:focus { border-color:rgba(200,162,106,.8); background:#201e16; }
.ct-url-input::placeholder { color:rgba(240,235,226,0.35); font-size:9.5px; }
.ct-url-btn { flex-shrink:0; padding:0 14px; border-radius:10px; min-height:44px; border:1.5px solid rgba(200,162,106,.5); background:rgba(200,162,106,.12); color:#c8a26a; font-family:'DM Mono','Courier New',monospace; font-size:9px; letter-spacing:.18em; text-transform:uppercase; cursor:pointer; -webkit-appearance:none; transition:all .2s; white-space:nowrap; }
.ct-url-btn:active { background:rgba(200,162,106,.25); transform:scale(.97); }
.ct-url-btn:disabled { opacity:.4; }
.ct-url-hint { font-family:'DM Mono','Courier New',monospace; font-size:8px; color:rgba(240,235,226,0.30); letter-spacing:.08em; text-align:center; }
.ct-loaded { background:rgba(255,255,255,0.03); }
.ct-file-row { display:flex; align-items:center; gap:10px; padding:14px 14px 0; }
.ct-file-icon { font-size:20px; flex-shrink:0; }
.ct-file-info { flex:1; min-width:0; }
.ct-file-name { font-family:'DM Mono','Courier New',monospace; font-size:10px; color:#7a9e7e; letter-spacing:.04em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.ct-file-meta { font-family:'DM Mono','Courier New',monospace; font-size:8px; color:rgba(240,235,226,0.30); letter-spacing:.1em; margin-top:2px; }
.ct-change-btn { flex-shrink:0; padding:6px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:rgba(255,255,255,0.03); color:rgba(240,235,226,0.40); font-family:'DM Mono','Courier New',monospace; font-size:8px; letter-spacing:.18em; text-transform:uppercase; cursor:pointer; -webkit-appearance:none; transition:all .2s; }
.ct-change-btn:active { border-color:rgba(200,162,106,.4); color:#c8a26a; }
.custom-controls { display:flex; align-items:center; gap:10px; padding:12px 14px; border-top:1px solid rgba(255,255,255,0.07); margin-top:12px; }
.custom-play-btn { width:36px; height:36px; border-radius:50%; flex-shrink:0; border:1px solid rgba(255,255,255,0.08); background:rgba(255,255,255,0.03); color:#f0ebe2; font-size:14px; cursor:pointer; display:flex; align-items:center; justify-content:center; -webkit-appearance:none; transition:all .2s; }
.custom-play-btn:active { transform:scale(.92); }
.custom-play-btn.playing { border-color:rgba(122,158,126,.5); color:#7a9e7e; }
.custom-waveform { flex:1; height:28px; border-radius:6px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.07); position:relative; overflow:hidden; }
.custom-progress { position:absolute; top:0; left:0; bottom:0; width:0%; background:linear-gradient(90deg,rgba(122,158,126,.4) 0%,rgba(122,158,126,.15) 100%); transition:width .5s linear; }
.custom-time { font-family:'DM Mono','Courier New',monospace; font-size:9px; color:rgba(240,235,226,0.40); letter-spacing:.08em; flex-shrink:0; min-width:38px; text-align:right; }
.custom-remove { width:28px; height:28px; border-radius:50%; flex-shrink:0; border:1px solid rgba(255,255,255,0.08); background:transparent; color:rgba(240,235,226,0.40); font-size:11px; cursor:pointer; display:flex; align-items:center; justify-content:center; -webkit-appearance:none; transition:all .2s; }
.custom-remove:active { color:#b07a8a; border-color:#b07a8a; }

@media (max-height:800px) { .countdown{font-size:clamp(90px,26vw,140px);} .breath-bars{height:58px;} }
@media (max-height:700px) { .app-header{padding:14px 24px 18px;} .countdown{font-size:clamp(76px,22vw,116px);} .breath-bars{height:50px;} .sec{padding:12px 24px 0;} }
@media (max-height:620px) { .countdown{font-size:72px;} .breath-bars{height:42px;} }

/* Light overrides */
:root.light .pn,:root.light .tk-name,:root.light .bq-name { color:#1e1a14; }
:root.light .toggle-label { color:#1e1a14; }
:root.light .ct-pick-main { color:#1e1a14; }
:root.light .ct-url-input { background:#ede7d8; border-color:#c8b898; color:#1e1a14; }
:root.light .ct-url-input:focus { background:#e8e0ce; }
:root.light .ct-url-input::placeholder { color:rgba(30,26,20,0.4); }
:root.light .debug-toggle { background:#f5f0e8; }
:root.light .binaural-note { color:rgba(30,26,20,0.30); }

/* ══ EQUALIZZATORE ══ */
.eq-presets { display:flex; gap:6px; margin-bottom:16px; flex-wrap:wrap; }
.eq-preset-btn {
  flex:1; min-width:0; padding:8px 6px; border-radius:10px;
  border:1px solid rgba(255,248,235,0.08);
  background:rgba(255,248,235,0.035);
  font-family:'DM Mono','Courier New',monospace; font-size:7.5px;
  letter-spacing:.12em; text-transform:uppercase; text-align:center;
  color:rgba(240,235,226,0.40); cursor:pointer; -webkit-appearance:none;
  transition:all .2s; line-height:1.4;
}
.eq-preset-btn:active { transform:scale(.96); }
.eq-preset-btn.active         { border-color:rgba(200,162,106,.55); background:rgba(200,162,106,.10); color:#c8a26a; }
.eq-preset-btn.active.p-sage  { border-color:rgba(122,158,126,.55); background:rgba(122,158,126,.10); color:#7a9e7e; }
.eq-preset-btn.active.p-rose  { border-color:rgba(176,122,138,.55); background:rgba(176,122,138,.10); color:#b07a8a; }
.eq-preset-icon { font-size:13px; display:block; margin-bottom:3px; }
.eq-bands {
  display:flex; gap:6px; align-items:flex-end;
  padding:14px 10px 10px;
  background:rgba(255,248,235,0.02);
  border:1px solid rgba(255,248,235,0.06); border-radius:13px;
}
.eq-band { flex:1; display:flex; flex-direction:column; align-items:center; gap:8px; }
.eq-fader-wrap { width:28px; height:100px; position:relative; display:flex; align-items:center; justify-content:center; }
.eq-fader-track { position:absolute; left:50%; transform:translateX(-50%); width:2px; height:100%; background:rgba(255,255,255,0.08); border-radius:2px; }
.eq-zero-line { position:absolute; left:-4px; right:-4px; top:50%; height:1px; background:rgba(255,255,255,0.15); pointer-events:none; }
.eq-fader-fill { position:absolute; left:0; right:0; border-radius:1px; transition:background .4s; }
.eq-fader-thumb {
  width:26px; height:26px; border-radius:50%;
  background:rgba(255,248,235,0.92); border:2px solid #c8a26a;
  box-shadow:0 2px 8px rgba(0,0,0,.5);
  position:absolute; left:50%; transform:translate(-50%,-50%);
  cursor:grab; touch-action:none;
  transition:border-color .4s;
}
.eq-fader-thumb:active { cursor:grabbing; transform:translate(-50%,-50%) scale(1.1); }
.eq-band-val {
  font-family:'DM Mono','Courier New',monospace; font-size:8px;
  color:rgba(240,235,226,0.45); letter-spacing:.04em;
  min-width:36px; text-align:center; transition:color .3s;
}
.eq-band-lbl {
  font-family:'DM Mono','Courier New',monospace; font-size:7px;
  color:rgba(240,235,226,0.28); letter-spacing:.1em; text-transform:uppercase;
  text-align:center; white-space:nowrap;
}
.eq-reset-btn {
  width:100%; margin-top:10px; padding:9px; border-radius:10px;
  border:1px solid rgba(255,255,255,0.07); background:transparent;
  font-family:'DM Mono','Courier New',monospace; font-size:8px;
  letter-spacing:.25em; text-transform:uppercase;
  color:rgba(240,235,226,0.30); cursor:pointer; -webkit-appearance:none; transition:all .2s;
}
.eq-reset-btn:active { border-color:rgba(200,162,106,.3); color:#c8a26a; }

/* ══ PREMIUM CONTRAST — DARK refinements ══ */
.panel-title         { color:rgba(240,235,226,0.50); }
.panel-section-title { color:rgba(240,235,226,0.32); }
.toggle-desc         { color:rgba(240,235,226,0.44); line-height:1.55; }
.audio-note-text     { color:rgba(240,235,226,0.46); line-height:1.72; }
.ct-url-hint         { color:rgba(240,235,226,0.34); }
.ct-or               { color:rgba(240,235,226,0.30); }
.ct-file-meta        { color:rgba(240,235,226,0.36); }
.custom-time         { color:rgba(240,235,226,0.45); }
.debug-key           { color:rgba(240,235,226,0.48); }
.binaural-note       { color:rgba(240,235,226,0.30); }
.sec-lbl             { color:rgba(240,235,226,0.26); }
.attr                { color:rgba(240,235,226,0.26); }
.pwa-hint            { color:rgba(240,235,226,0.24); }

/* ══ PREMIUM CONTRAST — LIGHT THEME ══ */
:root.light .panel-title         { color:rgba(30,26,20,0.52); }
:root.light .panel-section-title { color:rgba(30,26,20,0.42) !important; }
:root.light .toggle-label        { color:#1e1a14; }
:root.light .toggle-desc         { color:rgba(30,26,20,0.52); }
:root.light .audio-note          { background:rgba(30,26,20,0.04); border-color:rgba(30,26,20,0.10); }
:root.light .audio-note-title    { color:#9a6c32; }
:root.light .audio-note-text     { color:rgba(30,26,20,0.55); }
:root.light .audio-note strong   { color:#1e1a14; }
:root.light .ct-pick-main        { color:#1e1a14; }
:root.light .ct-url-input        { background:#ede7d8; border-color:#c8b898; color:#1e1a14; }
:root.light .ct-url-input:focus  { background:#e8e0ce; }
:root.light .ct-url-input::placeholder { color:rgba(30,26,20,0.40); }
:root.light .ct-url-hint         { color:rgba(30,26,20,0.42); }
:root.light .ct-or               { color:rgba(30,26,20,0.36); }
:root.light .ct-file-name        { color:#4a7a50; }
:root.light .ct-file-meta        { color:rgba(30,26,20,0.42); }
:root.light .ct-change-btn       { color:rgba(30,26,20,0.52); border-color:rgba(30,26,20,0.14); }
:root.light .custom-time         { color:rgba(30,26,20,0.52); }
:root.light .custom-waveform     { background:rgba(30,26,20,0.04); border-color:rgba(30,26,20,0.10); }
:root.light .custom-play-btn     { color:#1e1a14; border-color:rgba(30,26,20,0.16); background:rgba(30,26,20,0.04); }
:root.light .custom-remove       { color:rgba(30,26,20,0.42); border-color:rgba(30,26,20,0.12); }
:root.light .sw                  { background:rgba(30,26,20,0.18); }
:root.light .sw.on               { background:#9a6c32; }
:root.light .sw.on.sage          { background:#4a7a50; }
:root.light .sw-knob             { background:#ffffff; box-shadow:0 2px 6px rgba(0,0,0,0.22); }
:root.light .debug-key           { color:rgba(30,26,20,0.55); }
:root.light .debug-val           { color:#1e1a14; }
:root.light .debug-log           { background:rgba(30,26,20,0.04); border-color:rgba(30,26,20,0.10); color:rgba(30,26,20,0.55); }
:root.light .debug-btn           { color:rgba(30,26,20,0.55); border-color:rgba(30,26,20,0.12); background:rgba(30,26,20,0.03); }
:root.light .debug-btn.primary   { color:#9a6c32; border-color:rgba(154,108,50,.30); }
:root.light .debug-toggle        { background:#f5f0e8; color:rgba(30,26,20,0.36); }
:root.light .binaural-rec-icon   { color:#9a6c32; }
:root.light .binaural-note       { color:rgba(30,26,20,0.40); }
:root.light .sec-lbl             { color:rgba(30,26,20,0.38); }
:root.light .attr                { color:rgba(30,26,20,0.38); }
:root.light .pwa-hint            { color:rgba(30,26,20,0.32); }
:root.light .pn,:root.light .tk-name,:root.light .bq-name { color:#1e1a14; }
:root.light .eq-preset-btn       { border-color:rgba(30,26,20,0.18); background:rgba(30,26,20,0.04); color:rgba(30,26,20,0.55); }
:root.light .eq-bands            { background:rgba(30,26,20,0.03); border-color:rgba(30,26,20,0.12); }
:root.light .eq-band-lbl         { color:rgba(30,26,20,0.52); }
:root.light .eq-band-val         { color:rgba(30,26,20,0.62); }
:root.light .eq-fader-track      { background:rgba(0,0,0,0.13); }
:root.light .eq-fader-thumb      { background:rgba(30,26,20,0.88); }
:root.light .eq-zero-line        { background:rgba(0,0,0,0.20); }
:root.light .eq-reset-btn        { border-color:rgba(30,26,20,0.15); color:rgba(30,26,20,0.44); }

/* Panel general light-theme contrast fixes */
:root.light .panel-title { color:rgba(30,26,20,0.55); }
:root.light .panel-section-title { color:rgba(30,26,20,0.45) !important; }
:root.light .audio-note { background:rgba(30,26,20,0.04); border-color:rgba(30,26,20,0.10); }
:root.light .audio-note-title { color:#9a6c32; }
:root.light .audio-note-text { color:rgba(30,26,20,0.55); }
:root.light .audio-note strong { color:#1e1a14; }
:root.light .debug-key { color:rgba(30,26,20,0.55); }
:root.light .debug-val { color:#1e1a14; }
:root.light .debug-log { background:rgba(30,26,20,0.04); border-color:rgba(30,26,20,0.10); color:rgba(30,26,20,0.55); }
:root.light .debug-btn { color:rgba(30,26,20,0.55); border-color:rgba(30,26,20,0.12); background:rgba(30,26,20,0.03); }
:root.light .debug-btn.primary { color:#9a6c32; border-color:rgba(154,108,50,.30); }
:root.light .ct-url-hint { color:rgba(30,26,20,0.40); }
:root.light .ct-or { color:rgba(30,26,20,0.35); }
:root.light .ct-file-name { color:#4a7a50; }
:root.light .ct-file-meta { color:rgba(30,26,20,0.40); }
:root.light .ct-change-btn { color:rgba(30,26,20,0.50); border-color:rgba(30,26,20,0.14); }
:root.light .custom-time { color:rgba(30,26,20,0.50); }
:root.light .custom-waveform { background:rgba(30,26,20,0.04); border-color:rgba(30,26,20,0.10); }
:root.light .custom-play-btn { color:#1e1a14; border-color:rgba(30,26,20,0.15); background:rgba(30,26,20,0.04); }
:root.light .custom-remove { color:rgba(30,26,20,0.40); border-color:rgba(30,26,20,0.12); }
:root.light .sw { background:rgba(30,26,20,0.20); }
:root.light .sw.on { background:#9a6c32; }
:root.light .sw.on.sage { background:#4a7a50; }
:root.light .sw-knob { background:#ffffff; box-shadow:0 2px 6px rgba(0,0,0,0.25); }
:root.light .binaural-rec-icon { color:#9a6c32; }
:root.light .sec-lbl { color:rgba(30,26,20,0.35); }
:root.light .attr { color:rgba(30,26,20,0.35); }
:root.light .binaural-note { color:rgba(30,26,20,0.40); }

/* ══ GUIDE PANEL ══ */
.guide-hero {
  padding:28px 24px 24px;
  background:linear-gradient(150deg, rgba(200,162,106,0.08) 0%, transparent 65%);
  border-bottom:1px solid rgba(200,162,106,0.13);
  position:relative; overflow:hidden; flex-shrink:0;
}
.guide-hero::after {
  content:'◎'; position:absolute; right:18px; top:8px;
  font-size:96px; line-height:1;
  color:rgba(200,162,106,0.05); pointer-events:none; user-select:none;
}
.guide-hero-eyebrow {
  font-family:'DM Mono','Courier New',monospace;
  font-size:8px; letter-spacing:.44em; text-transform:uppercase;
  color:rgba(200,162,106,0.65); margin-bottom:8px;
}
.guide-hero-title { font-size:34px; font-weight:300; letter-spacing:.06em; line-height:1.08; color:#f0ebe2; margin-bottom:5px; }
.guide-hero-sub { font-family:'DM Mono','Courier New',monospace; font-size:8.5px; letter-spacing:.22em; color:rgba(240,235,226,0.36); }
.guide-body { flex:1; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch; overscroll-behavior:contain; padding:0 24px 48px; }
.guide-ch { padding:22px 0 20px; border-bottom:1px solid rgba(255,248,235,0.07); }
.guide-ch:last-child { border-bottom:none; }
.guide-ch-num { font-family:'DM Mono','Courier New',monospace; font-size:7.5px; letter-spacing:.44em; text-transform:uppercase; color:rgba(200,162,106,0.55); margin-bottom:6px; }
.guide-ch-title { font-size:22px; font-weight:400; letter-spacing:.04em; line-height:1.15; color:#f0ebe2; margin-bottom:12px; }
.guide-p { font-size:13.5px; font-weight:300; font-style:italic; line-height:1.78; color:rgba(240,235,226,0.50); margin-bottom:12px; }
.guide-p strong { font-style:normal; font-weight:400; color:rgba(240,235,226,0.82); }
/* Technique cards */
.guide-tech-list { display:flex; flex-direction:column; gap:9px; margin-bottom:14px; }
.gtc { border-radius:13px; padding:14px 15px 13px; border:1px solid rgba(255,248,235,0.085); background:rgba(255,248,235,0.025); position:relative; overflow:hidden; }
.gtc::before { content:''; position:absolute; left:0; top:0; bottom:0; width:3px; border-radius:3px 0 0 3px; }
.gtc.amber::before { background:#c8a26a; }
.gtc.sage::before  { background:#7a9e7e; }
.gtc.rose::before  { background:#b07a8a; }
.gtc-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:5px; gap:10px; }
.gtc-name { font-size:15px; font-weight:400; color:#f0ebe2; letter-spacing:.025em; }
.gtc-tag { font-family:'DM Mono','Courier New',monospace; font-size:7.5px; letter-spacing:.1em; padding:3px 9px; border-radius:8px; border:1px solid; flex-shrink:0; }
.gtc.amber .gtc-tag { color:#c8a26a; border-color:rgba(200,162,106,.32); background:rgba(200,162,106,.07); }
.gtc.sage  .gtc-tag { color:#7a9e7e; border-color:rgba(122,158,126,.32); background:rgba(122,158,126,.07); }
.gtc.rose  .gtc-tag { color:#b07a8a; border-color:rgba(176,122,138,.32); background:rgba(176,122,138,.07); }
.gtc-rhythm { font-family:'DM Mono','Courier New',monospace; font-size:8.5px; color:rgba(240,235,226,0.38); margin-bottom:7px; letter-spacing:.06em; }
.gtc-effect { font-size:12.5px; font-weight:300; font-style:italic; color:rgba(240,235,226,0.52); line-height:1.65; }
/* Chain block */
.guide-chain-box { border-radius:14px; padding:16px 16px 12px; border:1px solid rgba(255,248,235,0.08); background:rgba(255,248,235,0.02); margin-bottom:14px; }
.guide-chain-title { font-family:'DM Mono','Courier New',monospace; font-size:8px; letter-spacing:.32em; text-transform:uppercase; color:rgba(240,235,226,0.32); margin-bottom:12px; }
.gchain-row { display:flex; align-items:flex-start; gap:11px; margin-bottom:4px; }
.gchain-icon { font-size:16px; flex-shrink:0; margin-top:2px; width:22px; text-align:center; }
.gchain-body { flex:1; min-width:0; }
.gchain-lbl { font-family:'DM Mono','Courier New',monospace; font-size:7.5px; letter-spacing:.24em; text-transform:uppercase; color:rgba(240,235,226,0.30); margin-bottom:2px; }
.gchain-val { font-size:14px; font-weight:400; color:#f0ebe2; }
.gchain-note { font-family:'DM Mono','Courier New',monospace; font-size:8px; color:rgba(240,235,226,0.34); line-height:1.55; margin-top:2px; }
.gchain-arrow { text-align:center; padding:5px 0 5px 33px; font-family:'DM Mono','Courier New',monospace; font-size:9px; color:rgba(240,235,226,0.16); }
.gchain-manual { display:flex; gap:9px; align-items:flex-start; margin-top:11px; padding-top:11px; border-top:1px solid rgba(255,248,235,0.07); }
.gchain-manual-text { font-family:'DM Mono','Courier New',monospace; font-size:8px; color:rgba(240,235,226,0.40); line-height:1.65; letter-spacing:.02em; }
.gchain-manual-text strong { color:rgba(240,235,226,0.62); font-weight:400; }
/* Settings list */
.guide-set-list { display:flex; flex-direction:column; gap:7px; margin-bottom:14px; }
.gset { display:flex; gap:12px; align-items:flex-start; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,248,235,0.08); background:rgba(255,248,235,0.02); }
.gset-icon { font-size:18px; flex-shrink:0; margin-top:1px; width:24px; text-align:center; }
.gset-body { flex:1; min-width:0; }
.gset-name { font-size:14px; font-weight:400; color:#f0ebe2; margin-bottom:3px; }
.gset-desc { font-family:'DM Mono','Courier New',monospace; font-size:8px; color:rgba(240,235,226,0.40); line-height:1.65; letter-spacing:.02em; }
.gset-desc strong { color:rgba(240,235,226,0.60); font-weight:400; }
/* Binaural note / Notice */
.guide-bino { display:flex; gap:10px; align-items:flex-start; padding:11px 13px; border-radius:11px; margin-bottom:10px; background:rgba(140,140,220,0.06); border:1px solid rgba(140,140,220,0.18); }
.guide-bino-text { font-family:'DM Mono','Courier New',monospace; font-size:8px; color:rgba(240,235,226,0.44); line-height:1.68; letter-spacing:.02em; }
.guide-bino-text strong { color:rgba(200,180,255,0.65); font-weight:400; }
.guide-notice { display:flex; gap:10px; align-items:flex-start; padding:12px 14px; border-radius:12px; margin-top:8px; background:rgba(176,122,138,0.07); border:1px solid rgba(176,122,138,0.22); }
.guide-notice-icon { font-size:13px; flex-shrink:0; margin-top:2px; color:#b07a8a; }
.guide-notice-text { font-family:'DM Mono','Courier New',monospace; font-size:8px; color:rgba(240,235,226,0.46); line-height:1.72; letter-spacing:.02em; }
.guide-notice-text strong { color:rgba(240,235,226,0.68); font-weight:400; }
/* Light */
:root.light .guide-hero { background:linear-gradient(150deg,rgba(154,108,50,0.08) 0%,transparent 65%); border-bottom-color:rgba(154,108,50,0.15); }
:root.light .guide-hero::after { color:rgba(154,108,50,0.06); }
:root.light .guide-hero-eyebrow { color:rgba(154,108,50,0.75); }
:root.light .guide-hero-title { color:#1e1a14; }
:root.light .guide-hero-sub { color:rgba(30,26,20,0.40); }
:root.light .guide-ch { border-bottom-color:rgba(30,26,20,0.09); }
:root.light .guide-ch-num { color:rgba(154,108,50,0.65); }
:root.light .guide-ch-title { color:#1e1a14; }
:root.light .guide-p { color:rgba(30,26,20,0.55); }
:root.light .guide-p strong { color:rgba(30,26,20,0.85); }
:root.light .gtc { background:rgba(30,26,20,0.025); border-color:rgba(30,26,20,0.10); }
:root.light .gtc.amber::before { background:#9a6c32; }
:root.light .gtc.sage::before  { background:#4a7a50; }
:root.light .gtc.rose::before  { background:#884060; }
:root.light .gtc.amber .gtc-tag { color:#9a6c32; border-color:rgba(154,108,50,.30); background:rgba(154,108,50,.07); }
:root.light .gtc.sage  .gtc-tag { color:#4a7a50; border-color:rgba(74,122,80,.30); background:rgba(74,122,80,.07); }
:root.light .gtc.rose  .gtc-tag { color:#884060; border-color:rgba(136,64,96,.30); background:rgba(136,64,96,.07); }
:root.light .gtc-name { color:#1e1a14; }
:root.light .gtc-rhythm { color:rgba(30,26,20,0.42); }
:root.light .gtc-effect { color:rgba(30,26,20,0.57); }
:root.light .guide-chain-box { background:rgba(30,26,20,0.02); border-color:rgba(30,26,20,0.09); }
:root.light .guide-chain-title { color:rgba(30,26,20,0.36); }
:root.light .gchain-lbl { color:rgba(30,26,20,0.36); }
:root.light .gchain-val { color:#1e1a14; }
:root.light .gchain-note { color:rgba(30,26,20,0.42); }
:root.light .gchain-arrow { color:rgba(30,26,20,0.18); }
:root.light .gchain-manual { border-top-color:rgba(30,26,20,0.09); }
:root.light .gchain-manual-text { color:rgba(30,26,20,0.48); }
:root.light .gchain-manual-text strong { color:rgba(30,26,20,0.68); }
:root.light .gset { background:rgba(30,26,20,0.02); border-color:rgba(30,26,20,0.09); }
:root.light .gset-name { color:#1e1a14; }
:root.light .gset-desc { color:rgba(30,26,20,0.48); }
:root.light .gset-desc strong { color:rgba(30,26,20,0.68); }
:root.light .guide-bino { background:rgba(100,100,200,0.05); border-color:rgba(100,100,200,0.15); }
:root.light .guide-bino-text { color:rgba(30,26,20,0.52); }
:root.light .guide-bino-text strong { color:rgba(80,80,180,0.70); }
:root.light .guide-notice { background:rgba(136,64,96,0.05); border-color:rgba(136,64,96,0.20); }
:root.light .guide-notice-icon { color:#884060; }
:root.light .guide-notice-text { color:rgba(30,26,20,0.52); }
:root.light .guide-notice-text strong { color:rgba(30,26,20,0.72); }
</style>
</head>
<body>

<!-- ═══ SETUP ═══ -->
<div class="screen" id="setup">
  <div class="app-header">
    <!-- top row: titolo sinistra · Inizia destra -->
    <div class="app-header-top">
      <div class="app-title-wrap">
        <h1 class="app-title">Respira</h1>
        <p class="app-sub">respirazione assistita</p>
        <p class="app-credit">by ninGia zuleziM</p>
      </div>
      <button class="start-btn-header" id="startBtn">
        <span class="start-btn-lbl">Inizia</span>
        <span class="start-btn-arrow">›</span>
      </button>
    </div>
    <!-- riga: Salva · Tema · Guida · Impostazioni -->
    <div class="app-header-actions">
      <button class="save-btn" id="saveBtn" style="flex:1;">
        <span class="save-icon">↓</span>
        <span>Salva<br>impostazioni</span>
      </button>
      <button class="hdr-btn theme" id="themeBtnHeader" aria-label="Cambia tema">
        <span class="hdr-btn-icon" id="themeBtnIcon">◑</span>
        <span class="hdr-btn-lbl" id="themeBtnLabel">TEMA<br>SCURO</span>
      </button>
      <button class="hdr-btn" id="guideBtnHeader" aria-label="Guida all'uso">
        <span class="hdr-btn-lbl">Guida<br>d'uso</span>
      </button>
      <button class="hdr-btn" id="gearBtn" aria-label="Impostazioni">
        <span class="hdr-btn-icon">⚙</span>
        <span class="hdr-btn-lbl">Imposta-<br>zioni</span>
      </button>
    </div>
  </div>


  <!-- 01 — Pattern -->
  <div class="sec">
    <div class="sec-lbl">01 — Tecnica di respirazione</div>
    <div class="pattern-grid">
      <div class="pattern-card active" data-id="box">
        <div class="pm"></div>
        <div class="pi"><div class="pn">Box Breathing</div><div class="pd">Riduce stress acuto · stimola concentrazione</div></div>
        <span class="ph-chip">4·4·4·4</span>
      </div>
      <div class="pattern-card" data-id="deep">
        <div class="pm"></div>
        <div class="pi"><div class="pn">Coerenza Cardiaca</div><div class="pd">Equilibrio sistema nervoso · 5 respiri/min</div></div>
        <span class="ph-chip">5·5</span>
      </div>
      <div class="pattern-card" data-id="slow">
        <div class="pm"></div>
        <div class="pi"><div class="pn">Respirazione Lenta</div><div class="pd">Massimo rilassamento · attivazione vagale</div></div>
        <span class="ph-chip">6·6</span>
      </div>
    </div>
    <div class="preview-box" id="previewBars" style="margin-top:10px;"></div>
  </div>

  <!-- 02 — Durata -->
  <div class="sec">
    <div class="sec-lbl">02 — Durata sessione</div>
    <div class="dur-row">
      <div class="dur-pill active" data-min="3"><span class="dn">3</span><span class="dl">min</span></div>
      <div class="dur-pill" data-min="5"><span class="dn">5</span><span class="dl">min</span></div>
      <div class="dur-pill" data-min="7"><span class="dn">7</span><span class="dl">min</span></div>
      <div class="dur-pill" data-min="10"><span class="dn">10</span><span class="dl">min</span></div>
      <div class="dur-pill" data-min="15"><span class="dn">15</span><span class="dl">min</span></div>
      <div class="dur-pill" data-min="20"><span class="dn">20</span><span class="dl">min</span></div>
    </div>
  </div>

  <!-- 03 — Atmosfera sonora -->
  <div class="sec">
    <div class="sec-lbl">03 — Atmosfera sonora</div>
    <div class="track-list">

      <!-- ─── Tracce Reali 432 Hz ─── -->
      <div class="attr-divider" style="padding-top:0;padding-bottom:4px;"><span style="font-family:'DM Mono','Courier New',monospace;font-size:8px;letter-spacing:.22em;color:rgba(240,235,226,0.18);white-space:nowrap;">◎ TRACCE REALI · 432 Hz</span></div>

      <!-- ─── Subsonic Serenity ─── -->
      <div class="track-card" data-tid="serenity">
        <div class="tk-icon tk-real">◈</div>
        <div class="tk-info">
          <div class="tk-name">Subsonic Serenity</div>
          <div class="tk-desc">Fondamentali sub 432 Hz · campo armonico puro · respiro naturale</div>
          <div class="tk-rec-chip">◎ consigliato per Coerenza · Lenta</div>
        </div>
        <span class="tk-badge premium">432 Hz · real</span>
      </div>

      <!-- ─── Subterranean Resonance ─── -->
      <div class="track-card" data-tid="subterranean">
        <div class="tk-icon tk-real">◉</div>
        <div class="tk-info">
          <div class="tk-name">Subterranean Resonance</div>
          <div class="tk-desc">Risonanza tellurica 432 Hz · sub-bassi profondi · ancoramento totale</div>
          <div class="tk-rec-chip">◎ consigliato per Box Breathing</div>
        </div>
        <span class="tk-badge premium">432 Hz · real</span>
      </div>

      <!-- ─── Separator ─── -->
      <div class="attr-divider"><span style="font-family:'DM Mono','Courier New',monospace;font-size:8px;letter-spacing:.22em;color:rgba(240,235,226,0.18);white-space:nowrap;">◎ SINTETICHE · GENERAZIONE REAL-TIME</span></div>

      <!-- ─── Sintetiche ─── -->
      <div class="track-card active" data-tid="cosmos">
        <div class="tk-icon">🌌</div>
        <div class="tk-info">
          <div class="tk-name">Cosmo</div>
          <div class="tk-desc">Drone siderale · sine puri · spazio infinito</div>
        </div>
        <span class="tk-badge">sintetica</span>
      </div>
      <div class="track-card" data-tid="forest">
        <div class="tk-icon">🌿</div>
        <div class="tk-info">
          <div class="tk-name">Foresta</div>
          <div class="tk-desc">Pad organici · archi profondi · calore terroso</div>
        </div>
        <span class="tk-badge">sintetica</span>
      </div>
      <div class="track-card" data-tid="ocean">
        <div class="tk-icon">🌊</div>
        <div class="tk-info">
          <div class="tk-name">Oceano</div>
          <div class="tk-desc">Onde modulate · rumore filtrato · profondità</div>
        </div>
        <span class="tk-badge">sintetica</span>
      </div>
      <div class="track-card" data-tid="temple">
        <div class="tk-icon">🔔</div>
        <div class="tk-info">
          <div class="tk-name">Tempio</div>
          <div class="tk-desc">Campane tibetane · risonanza del silenzio</div>
        </div>
        <span class="tk-badge">sintetica</span>
      </div>

    </div>
    <div class="attr" style="padding-top:10px;">Sintetiche generate in real-time · Reali disponibili offline dopo il primo caricamento</div>
  </div>

  <!-- 04 — Potenziamento Binaurale -->
  <div class="sec">
    <div class="sec-lbl">04 — Potenziamento Binaurale</div>

    <!-- Smart recommendation chip -->
    <div class="binaural-rec" id="binauralRec">
      <span class="binaural-rec-icon">◎</span>
      <span class="binaural-rec-text" id="binauralRecText">Alpha 10 Hz consigliato per Box Breathing</span>
    </div>

    <div class="binaural-grid">
      <div class="binaural-card active" data-bid="none">
        <div class="bq-accent"></div>
        <div class="bq-info">
          <div class="bq-name">Nessuno</div>
          <div class="bq-desc">Solo atmosfera sonora</div>
        </div>
        <span class="bq-chip">off</span>
      </div>

      <div class="binaural-card rec-glow" data-bid="alpha">
        <div class="bq-accent"></div>
        <div class="bq-info">
          <div class="bq-hz">432 Hz · 442 Hz</div>
          <div class="bq-name">Alpha · 10 Hz</div>
          <div class="bq-desc">Onde alfa · calma vigile · focus · ideale Box Breathing</div>
        </div>
        <span class="bq-chip">live</span>
      </div>

      <div class="binaural-card" data-bid="theta">
        <div class="bq-accent"></div>
        <div class="bq-info">
          <div class="bq-hz">432 Hz · 438 Hz</div>
          <div class="bq-name">Theta · 6 Hz</div>
          <div class="bq-desc">Onde theta · rilassamento profondo · meditazione · ideale Lenta</div>
        </div>
        <span class="bq-chip">live</span>
      </div>
    </div>

    <div class="binaural-note">🎧 Richiede cuffie per l'effetto binaurale · generato in tempo reale dall'app</div>
  </div>

  <!-- 05 — Volume -->
  <div class="sec" style="padding-bottom:0">
    <div class="sec-lbl">05 — Volume</div>
    <div class="vol-wrap">
      <span class="vi">🔈</span>
      <input type="range" id="volSetup" min="0" max="1" step="0.05" value="0.6">
      <span class="vi">🔊</span>
    </div>
  </div>
  <p class="pwa-hint">Safari → Condividi → Aggiungi a schermata Home</p>
</div>

<!-- ═══ SESSION ═══ -->
<div class="screen hidden" id="session">
  <div class="orbs"><div class="orb orb1" id="orb1"></div><div class="orb orb2" id="orb2"></div></div>
  <div class="sess-hdr">
    <div style="display:flex;align-items:center;gap:8px;">
      <button class="close-btn" id="closeBtn">✕</button>
      <button class="gear-btn" id="gearBtnSession" aria-label="Impostazioni" style="opacity:.8;">⚙</button>
    </div>
    <div class="sess-meta">
      <div class="spl" id="sessPatLabel">Box 4-4-4-4</div>
      <div style="display:flex;align-items:center;gap:6px;justify-content:flex-end;margin-top:3px;">
        <span id="sessSoundIcon" style="font-size:22px;line-height:1;">🌌</span>
        <span class="shl" id="sessTrackLabel">Cosmo</span>
      </div>
    </div>
  </div>
  <div class="ticker"><span class="tdot" id="tickerDot"></span><span class="ttxt" id="tickerText">Avvio sintesi audio…</span></div>
  <div class="phase-info">
    <div class="phase-lbl" id="phaseLbl">—</div>
    <div class="countdown-row"><div class="countdown" id="countNum">1</div><div class="cunit">sec</div></div>
  </div>
  <div class="breath-wrap"><div class="breath-bars" id="breathBars"></div></div>
  <div class="sess-pattern-desc" id="sessPatternDesc">
    <div class="sess-pattern-name" id="sessPatternName">—</div>
    <div class="sess-pattern-text" id="sessPatternText">—</div>
    <div class="sess-pattern-steps" id="sessPatternSteps"></div>
  </div>
  <div class="sess-vol">
    <span class="vi">🔈</span>
    <input type="range" id="sessVol" min="0" max="1" step="0.05" value="0.6">
    <span class="vi">🔊</span>
  </div>
  <div class="prog-area">
    <div class="prog-track"><div class="prog-fill" id="progFill"></div></div>
    <div class="prog-time" id="progTime">—</div>
  </div>
</div>

<!-- ═══ END ═══ -->
<div class="screen hidden" id="end">
  <div class="end-mark">◎</div>
  <div><h2 class="end-title">Sessione<br>completata</h2></div>
  <div class="end-div"></div>
  <p class="end-sub">Prenditi un momento prima di rientrare nel mondo.<br>Il tuo sistema nervoso ti ringrazia.</p>
  <div class="end-stats">
    <div class="stat"><span class="stat-val" id="statMin">5</span><span class="stat-lbl">minuti</span></div>
    <div class="stat"><span class="stat-val" id="statCycles">—</span><span class="stat-lbl">cicli</span></div>
    <div class="stat"><span class="stat-val" id="statTrack">—</span><span class="stat-lbl">brano</span></div>
  </div>
  <button class="again-btn" id="againBtn">Nuova sessione</button>
</div>

<!-- ═══ GUIDE PANEL ═══ -->
<div class="overlay-panel hidden" id="guidePanel">
  <div class="panel-hdr">
    <span class="panel-title">◎ Guida all'uso</span>
    <button class="panel-close" id="guideClose">Chiudi</button>
  </div>

  <!-- Hero -->
  <div class="guide-hero">
    <div class="guide-hero-eyebrow">Respira · Guida</div>
    <div class="guide-hero-title">Respira<br>meglio.</div>
    <div class="guide-hero-sub">tecniche · impostazioni · catena sonora</div>
  </div>

  <!-- Scrollable body -->
  <div class="guide-body">

    <!-- ① Tecniche -->
    <div class="guide-ch">
      <div class="guide-ch-num">01 — Tecniche di respirazione</div>
      <div class="guide-ch-title">Cosa ottieni con ogni tecnica</div>
      <div class="guide-p">Ogni tecnica agisce sul sistema nervoso autonomo in modo diverso. Scegli in base all'obiettivo del momento — <strong>focus, equilibrio o rilassamento profondo.</strong></div>

      <div class="guide-tech-list">

        <div class="gtc amber">
          <div class="gtc-head">
            <span class="gtc-name">Box Breathing</span>
            <span class="gtc-tag">FOCUS · STRESS</span>
          </div>
          <div class="gtc-rhythm">4 sec Inspira · 4 sec Pausa · 4 sec Espira · 4 sec Pausa</div>
          <div class="gtc-effect">Abbassa il cortisolo in pochi minuti. Tecnica usata da atleti d'élite e forze speciali per recuperare lucidità mentale sotto pressione. Ideale prima di presentazioni, esami o momenti di tensione acuta.</div>
        </div>

        <div class="gtc sage">
          <div class="gtc-head">
            <span class="gtc-name">Coerenza Cardiaca</span>
            <span class="gtc-tag">EQUILIBRIO · HRV</span>
          </div>
          <div class="gtc-rhythm">5 sec Inspira · 5 sec Espira · 6 cicli al minuto</div>
          <div class="gtc-effect">Sincronizza il ritmo cardiaco con quello respiratorio (HRV biofeedback naturale). Migliora l'equilibrio del sistema nervoso autonomo nel tempo. Pratica quotidiana raccomandata: 5 min × 3 volte al giorno per effetti duraturi.</div>
        </div>

        <div class="gtc rose">
          <div class="gtc-head">
            <span class="gtc-name">Respirazione Lenta</span>
            <span class="gtc-tag">RILASSAMENTO · SONNO</span>
          </div>
          <div class="gtc-rhythm">4 sec Inspira · 7 sec Pausa · 8 sec Espira</div>
          <div class="gtc-effect">La tecnica 4-7-8 attiva il nervo vago e il sistema parasimpatico. L'espirazione lunga è la chiave: rallenta il battito cardiaco e predispone al sonno. Usala la sera, prima di dormire, o dopo eventi emotivamente intensi.</div>
        </div>

      </div>
    </div>

    <!-- ② Catena automatica -->
    <div class="guide-ch">
      <div class="guide-ch-num">02 — Catena di selezione automatica</div>
      <div class="guide-ch-title">Cosa succede quando scegli una tecnica</div>
      <div class="guide-p">Selezionando una tecnica, l'app configura automaticamente <strong>atmosfera sonora ed equalizzazione</strong> per massimizzare l'efficacia. Il Binaural rimane una scelta personale.</div>

      <!-- Box Breathing -->
      <div class="guide-chain-box">
        <div class="guide-chain-title">◼ Box Breathing — catena automatica</div>
        <div class="gchain-row">
          <div class="gchain-icon">🌊</div>
          <div class="gchain-body">
            <div class="gchain-lbl">Atmosfera suggerita</div>
            <div class="gchain-val">Cosmo · Foresta · Pioggia</div>
            <div class="gchain-note">Suoni freschi e ariosi · sostengono l'attenzione vigile</div>
          </div>
        </div>
        <div class="gchain-arrow">↓</div>
        <div class="gchain-row">
          <div class="gchain-icon">🎚</div>
          <div class="gchain-body">
            <div class="gchain-lbl">Equalizzazione auto</div>
            <div class="gchain-val">Box Breathing EQ</div>
            <div class="gchain-note">Sub tagliato −2 dB · Presenza +4 dB · favorisce la nitidezza mentale</div>
          </div>
        </div>
        <div class="gchain-manual">
          <div style="font-size:13px;flex-shrink:0;margin-top:1px;">🎧</div>
          <div class="gchain-manual-text"><strong>Binaural consigliato: Alpha 10 Hz</strong> — onde alfa per calma vigile e concentrazione. Aggiunta manuale nelle impostazioni → Potenziamento Binaurale.</div>
        </div>
      </div>

      <!-- Coerenza Cardiaca -->
      <div class="guide-chain-box">
        <div class="guide-chain-title">◉ Coerenza Cardiaca — catena automatica</div>
        <div class="gchain-row">
          <div class="gchain-icon">🌊</div>
          <div class="gchain-body">
            <div class="gchain-lbl">Atmosfera suggerita</div>
            <div class="gchain-val">Oceano · Ruscello · Vento</div>
            <div class="gchain-note">Suoni fluidi e continui · rispecchiano il ritmo cardiaco coerente</div>
          </div>
        </div>
        <div class="gchain-arrow">↓</div>
        <div class="gchain-row">
          <div class="gchain-icon">🎚</div>
          <div class="gchain-body">
            <div class="gchain-lbl">Equalizzazione auto</div>
            <div class="gchain-val">Coerenza Cardiaca EQ</div>
            <div class="gchain-note">Sub +3 dB · Bass +4 dB · Presenza −1 dB · calore e corpo senza eccitazione</div>
          </div>
        </div>
        <div class="gchain-manual">
          <div style="font-size:13px;flex-shrink:0;margin-top:1px;">🎧</div>
          <div class="gchain-manual-text"><strong>Binaural consigliato: Theta 6 Hz</strong> — onde theta per meditazione profonda e rilassamento cosciente. Aggiunta manuale nelle impostazioni.</div>
        </div>
      </div>

      <!-- Respirazione Lenta -->
      <div class="guide-chain-box">
        <div class="guide-chain-title">◈ Respirazione Lenta — catena automatica</div>
        <div class="gchain-row">
          <div class="gchain-icon">🌊</div>
          <div class="gchain-body">
            <div class="gchain-lbl">Atmosfera suggerita</div>
            <div class="gchain-val">Notte · Fuoco · Profondo</div>
            <div class="gchain-note">Suoni gravi e avvolgenti · favoriscono il distacco sensoriale</div>
          </div>
        </div>
        <div class="gchain-arrow">↓</div>
        <div class="gchain-row">
          <div class="gchain-icon">🎚</div>
          <div class="gchain-body">
            <div class="gchain-lbl">Equalizzazione auto</div>
            <div class="gchain-val">Respirazione Lenta EQ</div>
            <div class="gchain-note">Sub +5 dB · Mid −2 dB · Presenza −3 dB · immersione profonda, riduzione stimoli cognitivi</div>
          </div>
        </div>
        <div class="gchain-manual">
          <div style="font-size:13px;flex-shrink:0;margin-top:1px;">🎧</div>
          <div class="gchain-manual-text"><strong>Binaural consigliato: Delta 2 Hz</strong> — onde delta per rilassamento totale e preparazione al sonno. Aggiunta manuale nelle impostazioni.</div>
        </div>
      </div>

    </div>

    <!-- ③ Impostazioni disponibili -->
    <div class="guide-ch">
      <div class="guide-ch-num">03 — Impostazioni disponibili</div>
      <div class="guide-ch-title">Personalizza la tua sessione</div>
      <div class="guide-p">Ogni parametro è stato pensato per migliorare l'efficacia della pratica. <strong>Non serve toccare nulla</strong> — le impostazioni di default sono già ottimizzate per ciascuna tecnica.</div>

      <div class="guide-set-list">

        <div class="gset">
          <div class="gset-icon">🌬</div>
          <div class="gset-body">
            <div class="gset-name">Tecnica di respirazione</div>
            <div class="gset-desc">Box · Coerenza Cardiaca · Respirazione Lenta. <strong>Ogni scelta aggiorna automaticamente</strong> atmosfera e EQ. Cambiala liberamente in base all'obiettivo del momento.</div>
          </div>
        </div>

        <div class="gset">
          <div class="gset-icon">⏱</div>
          <div class="gset-body">
            <div class="gset-name">Durata sessione</div>
            <div class="gset-desc">Da 3 a 20 minuti. <strong>5 min</strong> per una pausa rapida · <strong>10–15 min</strong> per effetti profondi · <strong>20 min</strong> per meditazione strutturata.</div>
          </div>
        </div>

        <div class="gset">
          <div class="gset-icon">🎵</div>
          <div class="gset-body">
            <div class="gset-name">Atmosfera sonora</div>
            <div class="gset-desc">Tracce reali a 432 Hz (Cosmo, Foresta, Oceano…) o sintetiche generate in tempo reale. Le tracce reali richiedono il primo caricamento online, poi funzionano <strong>offline</strong>.</div>
          </div>
        </div>

        <div class="gset">
          <div class="gset-icon">🎧</div>
          <div class="gset-body">
            <div class="gset-name">Potenziamento Binaurale</div>
            <div class="gset-desc">Aggiunge battiti binaurali sovrapposti all'atmosfera. <strong>Richiede cuffie</strong> per funzionare. Alpha 10 Hz (focus) · Theta 6 Hz (meditazione) · Delta 2 Hz (sonno). Scelta sempre manuale.</div>
          </div>
        </div>

        <div class="gset">
          <div class="gset-icon">🔊</div>
          <div class="gset-body">
            <div class="gset-name">Volume</div>
            <div class="gset-desc">Regolabile in setup e durante la sessione. Mantieni un volume <strong>medio-basso</strong>: il cervello risponde meglio ai suoni non invasivi durante la respirazione.</div>
          </div>
        </div>

        <div class="gset">
          <div class="gset-icon">🎚</div>
          <div class="gset-body">
            <div class="gset-name">Equalizzatore 4 bande</div>
            <div class="gset-desc">Sub 80 Hz · Bass 250 Hz · Mid 1 kHz · Presence 4 kHz. Preset automatici per ogni tecnica, o regolazione manuale ±12 dB. <strong>Flat</strong> per riferimento neutro.</div>
          </div>
        </div>

        <div class="gset">
          <div class="gset-icon">📱</div>
          <div class="gset-body">
            <div class="gset-name">Modalità Cuffie / Altoparlanti</div>
            <div class="gset-desc">Cuffie: ottimizza la risposta in frequenza per l'ascolto in cuffia. Altoparlanti: <strong>taglia le sub-basse</strong> sotto 120 Hz per ridurre la distorsione degli speaker piccoli.</div>
          </div>
        </div>

        <div class="gset">
          <div class="gset-icon">⚡</div>
          <div class="gset-body">
            <div class="gset-name">Limiter Master</div>
            <div class="gset-desc">Comprime i picchi audio prima dell'uscita. <strong>Lascialo attivo</strong> con gli altoparlanti del telefono — evita la distorsione causata dalla sovrapposizione degli oscillatori sinusoidali.</div>
          </div>
        </div>

      </div>

      <!-- Binaural note -->
      <div class="guide-bino">
        <div style="font-size:13px;flex-shrink:0;margin-top:2px;">🎧</div>
        <div class="guide-bino-text">Il <strong>Potenziamento Binaurale</strong> è l'unica impostazione non automatica: richiedendo cuffie e una scelta personale sull'obiettivo (focus, meditazione, sonno), è sempre demandata all'utente. Le raccomandazioni sono visibili direttamente nel selettore.</div>
      </div>

    </div>

    <!-- ④ Traccia personale -->
    <div class="guide-ch">
      <div class="guide-ch-num">04 — Traccia personale</div>
      <div class="guide-ch-title">Porta la tua musica</div>
      <div class="guide-p">Puoi sostituire le atmosfere integrate con <strong>qualsiasi file audio</strong> — la tua musica meditativa, registrazioni naturali, o tracce terapeutiche. Formati supportati: MP3, AAC, WAV, OGG.</div>

      <div class="guide-notice">
        <div class="guide-notice-icon">◈</div>
        <div class="guide-notice-text"><strong>Versione non definitiva.</strong> Il caricamento di tracce personali è attualmente in fase di sviluppo. Alcune funzionalità potrebbero comportarsi in modo imprevisto a seconda del browser e del dispositivo. Il file viene salvato localmente sul dispositivo e non viene trasmesso a server esterni.</div>
      </div>

    </div>

  </div><!-- /guide-body -->
</div>

<!-- ═══ SETTINGS PANEL ═══ -->
<div class="overlay-panel hidden" id="settingsPanel">
  <div class="panel-hdr">
    <span class="panel-title">⚙ Impostazioni</span>
    <button class="panel-close" id="settingsClose">Chiudi</button>
  </div>
  <div class="panel-scroll">

    <!-- ═══ TEMA — prima opzione ═══ -->
    <div class="panel-section">
      <div class="panel-section-title">Tema</div>
      <div class="toggle-row" style="border-bottom:none;">
        <div class="toggle-info">
          <div class="toggle-label" id="swThemeLabel">Tema Scuro</div>
          <div class="toggle-desc" id="swThemeDesc">Attiva per passare alla modalità chiara.</div>
        </div>
        <button class="sw" id="swTheme" role="switch" aria-checked="false"><span class="sw-knob"></span></button>
      </div>
    </div>

    <div class="panel-section">
      <div class="panel-section-title">Audio</div>
      <div class="toggle-row">
        <div class="toggle-info">
          <div class="toggle-label">Modalità Cuffie</div>
          <div class="toggle-desc">Ottimizza le frequenze per cuffie e auricolari.<br>Disabilita se usi gli altoparlanti del telefono.</div>
        </div>
        <button class="sw on" id="swHeadphones" role="switch" aria-checked="true"><span class="sw-knob"></span></button>
      </div>
      <div class="toggle-row">
        <div class="toggle-info">
          <div class="toggle-label">Limiter Master</div>
          <div class="toggle-desc">Riduce la distorsione sugli altoparlanti.<br>Comprime i picchi audio prima dell'uscita.</div>
        </div>
        <button class="sw on sage" id="swLimiter" role="switch" aria-checked="true"><span class="sw-knob"></span></button>
      </div>
      <div class="audio-note">
        <div class="audio-note-title">PERCHÉ SI SENTE DISTORSIONE</div>
        <div class="audio-note-text">Gli oscillatori sinusoidali sommati creano picchi di ampiezza (clipping). Gli altoparlanti piccoli degli smartphone distorcono già a volumi medi, specialmente sotto i 100 Hz. Con le cuffie questo è quasi impercettibile.<br><br><strong style="color:#f0ebe2">Soluzione:</strong> il Limiter Master comprime i picchi · la Modalità Altoparlante taglia le sub-basse sotto 120 Hz.</div>
      </div>
    </div>

    <!-- ═══ EQUALIZZATORE ═══ -->
    <div class="panel-section">
      <div class="panel-section-title">Equalizzatore</div>

      <!-- Preset buttons -->
      <div class="eq-presets">
        <button class="eq-preset-btn" data-preset="flat" id="eqPresetFlat">
          <span class="eq-preset-icon">▬</span>Flat
        </button>
        <button class="eq-preset-btn active" data-preset="box" id="eqPresetBox">
          <span class="eq-preset-icon">◼</span>Box<br>Breathing
        </button>
        <button class="eq-preset-btn p-sage" data-preset="deep" id="eqPresetDeep">
          <span class="eq-preset-icon">◉</span>Coerenza<br>Cardiaca
        </button>
        <button class="eq-preset-btn p-rose" data-preset="slow" id="eqPresetSlow">
          <span class="eq-preset-icon">◈</span>Resp.<br>Lenta
        </button>
      </div>

      <!-- 4-band vertical faders (built by JS) -->
      <div class="eq-bands" id="eqBands"></div>

      <button class="eq-reset-btn" id="eqResetBtn">◌ reset equalizzatore</button>
    </div>

    <div class="panel-section">
      <div class="panel-section-title">Traccia Personale</div>
      <div class="toggle-row">
        <div class="toggle-info">
          <div class="toggle-label">Usa traccia personale</div>
          <div class="toggle-desc">Sostituisce atmosfera sonora con il tuo audio. Formati supportati: MP3, AAC, WAV, OGG.</div>
        </div>
        <button class="sw" id="swCustomTrack" role="switch" aria-checked="false"><span class="sw-knob"></span></button>
      </div>
      <div class="custom-track-area disabled" id="customTrackArea">
        <div class="ct-empty" id="ctEmpty">
          <label class="ct-pick-btn" for="customFileInput">
            <span class="ct-pick-icon">📂</span>
            <span><span class="ct-pick-main">Scegli dal dispositivo</span><span class="ct-pick-sub">MP3 · AAC · WAV · OGG · FLAC</span></span>
          </label>
          <input type="file" id="customFileInput" accept="audio/*,.mp3,.aac,.wav,.ogg,.flac,.m4a,.opus">
          <div class="ct-or"><span>oppure</span></div>
          <div class="ct-url-row">
            <input type="url" id="customUrlInput" class="ct-url-input" placeholder="https://… (link diretto a file audio)" autocomplete="off" autocorrect="off" spellcheck="false">
            <button class="ct-url-btn" id="customUrlBtn">Carica</button>
          </div>
          <div class="ct-url-hint">Incolla l'URL diretto di un file audio online</div>
        </div>
        <div class="ct-loaded" id="ctLoaded" style="display:none">
          <div class="ct-file-row">
            <span class="ct-file-icon">🎵</span>
            <div class="ct-file-info">
              <div class="ct-file-name" id="ctFileName">—</div>
              <div class="ct-file-meta" id="ctFileMeta">—</div>
            </div>
            <button class="ct-change-btn" id="ctChangeBtn">Cambia</button>
          </div>
          <div class="custom-controls">
            <button class="custom-play-btn" id="customPlayBtn">▶</button>
            <div class="custom-waveform"><div class="custom-progress" id="customProgress"></div></div>
            <span class="custom-time" id="customTime">0:00</span>
            <button class="custom-remove" id="customRemove">✕</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ═══ DEBUG PANEL ═══ -->
<button class="debug-toggle hidden" id="debugToggle">◉ debug</button>
<div class="overlay-panel hidden" id="debugPanel">
  <div class="panel-hdr">
    <span class="panel-title">◉ Debug</span>
    <button class="panel-close" id="debugClose">Chiudi</button>
  </div>
  <div class="panel-scroll">
    <div class="debug-section">
      <div class="debug-section-title">Dispositivo</div>
      <div class="debug-row"><span class="debug-key">User Agent</span><span class="debug-val" id="dbUA">—</span></div>
      <div class="debug-row"><span class="debug-key">Safari / iOS</span><span class="debug-val" id="dbSafari">—</span></div>
      <div class="debug-row"><span class="debug-key">Risoluzione</span><span class="debug-val" id="dbRes">—</span></div>
    </div>
    <div class="debug-section">
      <div class="debug-section-title">Audio Engine</div>
      <div class="debug-row"><span class="debug-key">AudioContext</span><span class="debug-val" id="dbAC">—</span></div>
      <div class="debug-row"><span class="debug-key">Sintesi attiva</span><span class="debug-val" id="dbSynth">—</span></div>
      <div class="debug-row"><span class="debug-key">Atmosfera</span><span class="debug-val" id="dbTrack">—</span></div>
      <div class="debug-row"><span class="debug-key">Binaural</span><span class="debug-val" id="dbBinaural">—</span></div>
      <div class="debug-row"><span class="debug-key">Nodi audio</span><span class="debug-val" id="dbNodes">—</span></div>
    </div>
    <div class="debug-section">
      <div class="debug-section-title">Log eventi</div>
      <div class="debug-log" id="dbLog">—</div>
    </div>
  </div>
  <div class="debug-actions">
    <button class="debug-btn primary" id="dbCopy">Copia log</button>
    <button class="debug-btn" id="dbCloseBtn">Chiudi</button>
  </div>
</div>

<script>
'use strict';

/* ══ PANEL COLORS (Safari-proof: set via JS not CSS vars) ══ */
var PANEL_COLORS = {
  dark:  { bg:'#080705', border:'rgba(255,255,255,0.07)', text:'#f0ebe2', muted:'rgba(240,235,226,0.40)' },
  light: { bg:'#f5f0e8', border:'rgba(60,40,10,0.10)',    text:'#1e1a14', muted:'rgba(30,26,20,0.45)' }
};
function setPanelColors(theme) {
  var c = PANEL_COLORS[theme] || PANEL_COLORS.dark;
  document.querySelectorAll('.overlay-panel').forEach(function(p){ p.style.backgroundColor=c.bg; p.style.color=c.text; });
  document.querySelectorAll('.panel-close').forEach(function(b){ b.style.backgroundColor=theme==='light'?'rgba(0,0,0,0.05)':'rgba(255,255,255,0.05)'; b.style.borderColor=c.border; b.style.color=c.muted; });
  document.querySelectorAll('.panel-hdr').forEach(function(h){ h.style.borderBottomColor=c.border; });
  document.querySelectorAll('.toggle-label').forEach(function(el){ el.style.color=c.text; });
  document.querySelectorAll('.toggle-desc').forEach(function(el){ el.style.color=c.muted; });
  document.querySelectorAll('.toggle-row').forEach(function(el){ el.style.borderBottomColor=c.border; });
  document.querySelectorAll('.panel-section-title').forEach(function(el){ el.style.color=theme==='light'?'rgba(30,26,20,0.35)':'rgba(240,235,226,0.30)'; });
  var dt=document.getElementById('debugToggle'); if(dt) dt.style.backgroundColor=c.bg;
  updateEqThumbColors();
}

/* ══ DATI ══ */
var PATTERNS = {
  box:  { name:'Box 4-4-4-4', color:'#c8a26a', phases:[{n:'Inspira',d:4},{n:'Trattieni',d:4},{n:'Espira',d:4},{n:'Pausa',d:4}], desc:'Inspira, trattieni, espira e pausa — ognuna 4 secondi. Attiva il sistema parasimpatico, riduce il cortisolo e riporta l\'attenzione al momento presente.', steps:['Inspira 4s','Trattieni 4s','Espira 4s','Pausa 4s'] },
  deep: { name:'Coerenza Cardiaca', color:'#7a9e7e', phases:[{n:'Inspira',d:5},{n:'Espira',d:5}], desc:'5 respiri al minuto per 5 minuti: sincronizza la variabilità cardiaca, bilancia il sistema nervoso autonomo e abbassa la pressione sanguigna.', steps:['Inspira 5s','Espira 5s'] },
  slow: { name:'Respirazione Lenta', color:'#b07a8a', phases:[{n:'Inspira',d:6},{n:'Espira',d:6}], desc:'Respiro a 5 atti al minuto con espiro prolungato. Massima attivazione vagale, riduzione dell\'ansia e promozione del sonno profondo.', steps:['Inspira 6s','Espira 6s'] }
};
var PC = { Inspira:'#c8a26a', Trattieni:'#7a9e7e', Espira:'#b07a8a', Pausa:'#9a8a78' };

/* ── Tracce: sintetiche + reali MP3 ── */
var TRACKS = {
  cosmos:       { name:'Cosmo',                  color:'#7a8ea0', icon:'🌌', synth:true },
  forest:       { name:'Foresta',                color:'#7a9e7a', icon:'🌿', synth:true },
  ocean:        { name:'Oceano',                 color:'#6a8a9e', icon:'🌊', synth:true },
  temple:       { name:'Tempio',                 color:'#9a8a7a', icon:'🔔', synth:true },
  serenity:     { name:'Subsonic Serenity',      color:'#8a9e7a', icon:'◈',  synth:false, url:'432-55-66-Subsonic_Serenity.mp3',       recFor:['deep','slow'] },
  subterranean: { name:'Subterranean Resonance', color:'#7a8aae', icon:'◉',  synth:false, url:'432-4444-Subterranean_Resonance.mp3',   recFor:['box'] }
};

/* ── Modi binaurali ── */
var BINAURAL = {
  none:  { name:'Nessuno',     hz:0,  base:0,   beat:0,   recFor:[] },
  alpha: { name:'Alpha 10 Hz', hz:10, base:432, beat:10,  recFor:['box'],        desc:'Alpha 10 Hz · consigliato per Box Breathing' },
  theta: { name:'Theta 6 Hz',  hz:6,  base:432, beat:6,   recFor:['deep','slow'],desc:'Theta 6 Hz · consigliato per Coerenza · Lenta' }
};

/* ══ CONFIG ══ */
var cfg  = { pattern:'box', minutes:3, track:'cosmos', binaural:'none', vol:0.6 };
var sess = { timer:null, total:0, elapsed:0, phIdx:0, phElapsed:0, cycles:0 };
var audioOpts = { headphones:true, limiter:true };
var customOpts = { enabled:false, fileName:null };

/* ══ PERSISTENZA ══ */
var STORAGE_KEY='respira_cfg_v2', SETTINGS_KEY='respira_settings_v1', THEME_KEY='respira_theme_v1';
function saveSettings() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify({pattern:cfg.pattern,minutes:cfg.minutes,track:cfg.track,binaural:cfg.binaural,vol:cfg.vol})); return true; } catch(e) { dlog('Salvataggio fallito: '+e.message,'error'); return false; }
}
function loadSettings() {
  try { var r=localStorage.getItem(STORAGE_KEY); if(!r)return false; var s=JSON.parse(r);
    if(s.pattern&&PATTERNS[s.pattern])cfg.pattern=s.pattern;
    if(s.minutes)cfg.minutes=s.minutes;
    if(s.track&&TRACKS[s.track])cfg.track=s.track;
    if(s.binaural&&BINAURAL[s.binaural])cfg.binaural=s.binaural;
    if(typeof s.vol==='number')cfg.vol=s.vol;
    return true; } catch(e){return false;}
}
function applySettingsToUI() {
  qsa('.pattern-card').forEach(function(c){c.classList.toggle('active',c.dataset.id===cfg.pattern);});
  qsa('.dur-pill').forEach(function(p){p.classList.toggle('active',parseInt(p.dataset.min)===cfg.minutes);});
  qsa('.track-card').forEach(function(c){c.classList.toggle('active',c.dataset.tid===cfg.track);});
  qsa('.binaural-card').forEach(function(c){c.classList.toggle('active',c.dataset.bid===cfg.binaural);});
  var vs=qs('volSetup'); if(vs) vs.value=cfg.vol;
  updateRecommendations();
}
function saveAllSettings() {
  try { localStorage.setItem(SETTINGS_KEY,JSON.stringify({headphones:audioOpts.headphones,limiter:audioOpts.limiter,customEnabled:customOpts.enabled})); } catch(e){}
}
function loadAllSettings() {
  try { var r=localStorage.getItem(SETTINGS_KEY); if(!r)return; var s=JSON.parse(r);
    if(typeof s.headphones==='boolean')audioOpts.headphones=s.headphones;
    if(typeof s.limiter==='boolean')audioOpts.limiter=s.limiter;
    if(typeof s.customEnabled==='boolean')customOpts.enabled=s.customEnabled; } catch(e){}
}

/* ══ SMART RECOMMENDATIONS ══ */
function updateRecommendations() {
  var pat = cfg.pattern;

  /* Track recommendation chips */
  qsa('.track-card').forEach(function(c) {
    var tid = c.dataset.tid;
    var t = TRACKS[tid];
    var isRec = t && t.recFor && t.recFor.indexOf(pat) !== -1;
    c.classList.toggle('rec-active', isRec);
  });

  /* Binaural recommendation chips + glow */
  qsa('.binaural-card').forEach(function(c) {
    var bid = c.dataset.bid;
    var b = BINAURAL[bid];
    var isRec = b && b.recFor && b.recFor.indexOf(pat) !== -1;
    c.classList.toggle('rec-glow', isRec);
  });

  /* Top recommendation banner */
  var rec = qs('binauralRec');
  var recTxt = qs('binauralRecText');
  if (pat === 'box') {
    rec.className = 'binaural-rec'; /* amber */
    recTxt.textContent = 'Binaural Alpha 10 Hz consigliato per Box Breathing';
    rec.classList.remove('hidden');
  } else if (pat === 'deep' || pat === 'slow') {
    rec.className = 'binaural-rec rec-theta';
    recTxt.textContent = 'Binaural Theta 6 Hz consigliato per ' + (pat==='deep'?'Coerenza Cardiaca':'Respirazione Lenta');
    rec.classList.remove('hidden');
  } else {
    rec.classList.add('hidden');
  }
}

/* ══ DEBUG ══ */
var dbLogs=[];
function dlog(msg,level){ var ts=new Date().toTimeString().slice(0,8); dbLogs.push('['+ts+'] '+(level?level.toUpperCase()+': ':'')+msg); var el=qs('dbLog'); if(el){el.textContent=dbLogs.join('\n');el.scrollTop=el.scrollHeight;} if(level==='error'){var t=qs('debugToggle');if(t)t.classList.add('has-error');} }
function dset(id,val,cls){var e=qs(id);if(!e)return;e.textContent=val;e.className='debug-val'+(cls?' '+cls:'');}
function updateDebug(){
  var ua=navigator.userAgent;
  dset('dbUA',ua.length>55?ua.slice(0,55)+'…':ua);
  var isSafari=/Safari/.test(ua)&&!/Chrome/.test(ua),isIOS=/iPhone|iPad|iPod/.test(ua);
  dset('dbSafari',(isSafari?'Safari ✓':'Non Safari')+(isIOS?' · iOS ✓':' · Non iOS'),isSafari||isIOS?'ok':'warn');
  dset('dbRes',window.screen.width+'×'+window.screen.height+' @'+window.devicePixelRatio+'x');
  dset('dbAC',AC?'stato: '+AC.state+(AC.state==='running'?' ✓':''):'non inizializzato',AC&&AC.state==='running'?'ok':'warn');
  dset('dbSynth',synthActive?'in esecuzione ✓':'fermo',synthActive?'ok':'warn');
  var tn=TRACKS[cfg.track]; dset('dbTrack',cfg.track+' · '+(tn?tn.name:'?')+(tn&&!tn.synth?' [MP3]':' [synth]'));
  dset('dbBinaural',cfg.binaural==='none'?'off':BINAURAL[cfg.binaural].name+(binauralNodes?' ✓':' (non avviato)'),cfg.binaural!=='none'&&binauralNodes?'ok':'warn');
  dset('dbNodes',activeNodes.length+' nodi sintetica · binaural: '+(binauralNodes?'attivo':'off'));
}
function showDebugToggle(show){qs('debugToggle').classList.toggle('hidden',!show);}

qs('debugToggle').addEventListener('click',function(){updateDebug();openPanel('debugPanel');});
qs('debugClose').addEventListener('click',function(){closePanel('debugPanel');});
qs('dbCloseBtn').addEventListener('click',function(){closePanel('debugPanel');});
qs('dbCopy').addEventListener('click',function(){
  updateDebug();
  var text='=== RESPIRA DEBUG ===\nData: '+new Date().toISOString()+'\n'+dbLogs.join('\n');
  if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(text).then(function(){var b=qs('dbCopy');b.textContent='✓ Copiato';setTimeout(function(){b.textContent='Copia log';},2000);});}
});

/* ══ PANEL OPEN/CLOSE (Safari-proof) ══ */
function openPanel(id) {
  var el=qs(id); if(!el)return;
  setPanelColors(currentTheme);
  el.classList.remove('hidden');
  el.style.display='none'; el.offsetHeight; el.style.display='';
}
function closePanel(id) { var el=qs(id); if(el)el.classList.add('hidden'); }

/* ══ WEB AUDIO ENGINE ══ */
var AC=null,masterGain=null,activeNodes=[],synthActive=false,synthTimers=[];
var masterHPF=null,masterComp=null;
/* Binaural nodes */
var binauralNodes=null;

/* ══ EQ DATA ══ */
var EQ_BANDS_DEF = [
  { id:'sub',  label:'Sub',  freq:80,   Q:0.8, color:'#9a9adb' },
  { id:'bass', label:'Bass', freq:250,  Q:1.0, color:'#c8a26a' },
  { id:'mid',  label:'Mid',  freq:1000, Q:1.2, color:'#7a9e7e' },
  { id:'pres', label:'Pres', freq:4000, Q:1.5, color:'#b07a8a' }
];
/* Preset gains [sub, bass, mid, presence] dB
   Box Breathing  : focus, presenza mentale vigile → taglia sub morbidi, alza presenza
   Coerenza Card. : equilibrio caldo → sub caldi, bassi pieni, alta quasi piatta
   Resp. Lenta    : massimo rilassamento → sub profondi, mid/alta tagliati          */
var EQ_PRESETS = {
  flat: [  0,  0,  0,  0 ],
  box:  [ -2,  3,  1,  4 ],
  deep: [  3,  4,  0, -1 ],
  slow: [  5,  3, -2, -3 ]
};
var eqGains        = [0, 0, 0, 0];
var eqNodes        = [];
var currentEqPreset = 'box';
var EQ_DB_MAX       = 12;

/* ══ EQ AUDIO CHAIN ══ */
function buildEQChain(){
  if(!AC||!masterGain)return;
  try{ masterGain.disconnect(); }catch(e){}
  eqNodes = [];
  var prev = masterGain;
  EQ_BANDS_DEF.forEach(function(band, i){
    var f = AC.createBiquadFilter();
    f.type = 'peaking';
    f.frequency.value = band.freq;
    f.Q.value = band.Q;
    f.gain.value = eqGains[i];
    prev.connect(f);
    eqNodes.push(f);
    prev = f;
  });
  prev.connect(masterHPF);
  masterHPF.connect(masterComp);
  masterComp.connect(AC.destination);
  dlog('EQ chain: 4 bande peaking','ok');
}

function applyEQGain(i, db){
  eqGains[i] = db;
  if(eqNodes[i] && AC)
    eqNodes[i].gain.setTargetAtTime(db, AC.currentTime, 0.04);
}

function applyEQPreset(id, animate){
  var gains = EQ_PRESETS[id]; if(!gains) return;
  currentEqPreset = id;
  gains.forEach(function(db, i){ applyEQGain(i, db); });
  EQ_BANDS_DEF.forEach(function(_, i){ setFaderUI(i, eqGains[i], animate!==false); });
  qsa('.eq-preset-btn').forEach(function(b){ b.classList.toggle('active', b.dataset.preset===id); });
  saveEQ();
  dlog('EQ preset: '+id+' ['+gains.join(', ')+'] dB');
}

/* ══ EQ UI — vertical faders ══ */
function buildEQUI(){
  var container = qs('eqBands'); if(!container)return;
  container.innerHTML = '';
  EQ_BANDS_DEF.forEach(function(band, i){
    /* Column */
    var col  = mkEl('div','eq-band');
    /* dB value label */
    var valEl = mkEl('div','eq-band-val'); valEl.id='eqVal'+i; valEl.textContent='0 dB';
    /* Fader track */
    var wrap  = mkEl('div','eq-fader-wrap');
    var track = mkEl('div','eq-fader-track'); track.id='eqTrack'+i;
    var zero  = mkEl('div','eq-zero-line');
    var fill  = mkEl('div','eq-fader-fill'); fill.id='eqFill'+i;
    var thumb = mkEl('div','eq-fader-thumb'); thumb.id='eqThumb'+i;
    thumb.style.borderColor = band.color;
    thumb.style.boxShadow   = '0 2px 8px rgba(0,0,0,.5), 0 0 8px '+band.color+'44';
    track.appendChild(zero); track.appendChild(fill); track.appendChild(thumb);
    wrap.appendChild(track);
    /* Freq label */
    var lbl = mkEl('div','eq-band-lbl'); lbl.textContent=band.label;
    col.appendChild(valEl); col.appendChild(wrap); col.appendChild(lbl);
    container.appendChild(col);
    setFaderUI(i, eqGains[i], false);
    attachFaderDrag(i, track);
  });
}

function setFaderUI(i, db, animate){
  var thumb = document.getElementById('eqThumb'+i);
  var fill  = document.getElementById('eqFill'+i);
  var valEl = document.getElementById('eqVal'+i);
  if(!thumb||!fill||!valEl) return;
  var pct    = db / EQ_DB_MAX;          /* -1..+1 */
  var topPct = 50 - pct*50;             /* 0%=top=+12dB, 100%=bottom=-12dB */
  var dur    = animate ? '.22s' : '0s';
  thumb.style.transition = 'top '+dur+' cubic-bezier(.4,0,.2,1), border-color .4s';
  fill.style.transition  = 'height '+dur+' cubic-bezier(.4,0,.2,1), top '+dur+', background .4s';
  thumb.style.top = topPct+'%';
  /* Fill bar: from centre toward thumb */
  var fillPct = Math.abs(pct)*50;
  if(db >= 0){
    fill.style.bottom='50%'; fill.style.top='auto';
    fill.style.height=fillPct+'%';
    fill.style.background = EQ_BANDS_DEF[i].color;
  } else {
    fill.style.top='50%'; fill.style.bottom='auto';
    fill.style.height=fillPct+'%';
    fill.style.background = '#b07a8a';
  }
  var label = db===0?'0 dB':(db>0?'+':'')+db.toFixed(0)+' dB';
  valEl.textContent = label;
  valEl.style.color = db===0?'rgba(240,235,226,0.32)':EQ_BANDS_DEF[i].color;
}

function attachFaderDrag(i, track){
  var dragging=false;
  function dbFromY(clientY){
    var rect=track.getBoundingClientRect();
    var rel=(clientY-rect.top)/rect.height; /* 0=top=+max, 1=bottom=-max */
    var db=(0.5-rel)*2*EQ_DB_MAX;
    return Math.max(-EQ_DB_MAX, Math.min(EQ_DB_MAX, Math.round(db)));
  }
  function onStart(e){
    dragging=true;
    currentEqPreset='custom';
    qsa('.eq-preset-btn').forEach(function(b){b.classList.remove('active');});
    e.preventDefault();
  }
  function onMove(e){
    if(!dragging)return;
    var cy=e.touches?e.touches[0].clientY:e.clientY;
    var db=dbFromY(cy);
    if(db!==eqGains[i]){ applyEQGain(i,db); setFaderUI(i,db,false); saveEQ(); }
    e.preventDefault();
  }
  function onEnd(){ dragging=false; saveEQ(); }
  var thumb=document.getElementById('eqThumb'+i);
  thumb.addEventListener('mousedown',  onStart,{passive:false});
  thumb.addEventListener('touchstart', onStart,{passive:false});
  document.addEventListener('mousemove',  onMove,{passive:false});
  document.addEventListener('touchmove',  onMove,{passive:false});
  document.addEventListener('mouseup',  onEnd);
  document.addEventListener('touchend', onEnd);
  /* Click anywhere on track to jump */
  track.addEventListener('click',function(e){
    if(e.target===thumb)return;
    var db=dbFromY(e.clientY);
    applyEQGain(i,db); setFaderUI(i,db,true);
    currentEqPreset='custom';
    qsa('.eq-preset-btn').forEach(function(b){b.classList.remove('active');});
    saveEQ();
  });
}

function updateEqThumbColors(){
  var isDark=(currentTheme!=='light');
  EQ_BANDS_DEF.forEach(function(band,i){
    var t=document.getElementById('eqThumb'+i);
    if(t) t.style.background=isDark?'rgba(255,248,235,0.92)':'rgba(30,26,20,0.88)';
  });
}

/* EQ persistence */
function saveEQ(){ try{localStorage.setItem('respira_eq_v1',JSON.stringify({gains:eqGains,preset:currentEqPreset}));}catch(e){} }
function loadEQ(){
  try{
    var r=localStorage.getItem('respira_eq_v1'); if(!r)return;
    var s=JSON.parse(r);
    if(Array.isArray(s.gains)&&s.gains.length===4) eqGains=s.gains;
    if(s.preset) currentEqPreset=s.preset;
  }catch(e){}
}

/* EQ preset buttons + reset */
function wireEQButtons(){
  qsa('.eq-preset-btn').forEach(function(btn){
    btn.addEventListener('click',function(){ applyEQPreset(btn.dataset.preset, true); });
  });
  var rb=qs('eqResetBtn'); if(rb) rb.addEventListener('click',function(){ applyEQPreset('flat',true); });
}

function initAC(){
  if(AC)return true;
  try{
    AC=new(window.AudioContext||window.webkitAudioContext)();
    masterGain=AC.createGain(); masterGain.gain.value=cfg.vol;
    masterHPF=AC.createBiquadFilter(); masterHPF.type='highpass'; masterHPF.Q.value=0.5;
    masterComp=AC.createDynamicsCompressor(); masterComp.threshold.value=-6; masterComp.knee.value=3; masterComp.ratio.value=12; masterComp.attack.value=0.003; masterComp.release.value=0.18;
    masterGain.connect(masterHPF); masterHPF.connect(masterComp); masterComp.connect(AC.destination);
    buildEQChain();
    applyAudioProfile();
    dlog('AudioContext OK','ok'); return true;
  }catch(e){dlog('AudioContext FALLITO: '+e.message,'error');return false;}
}
function applyAudioProfile(){
  if(!AC||!masterHPF||!masterComp)return;
  var t=AC.currentTime;
  if(audioOpts.headphones){masterHPF.frequency.setTargetAtTime(30,t,0.1);masterHPF.Q.setTargetAtTime(0.3,t,0.1);}
  else{masterHPF.frequency.setTargetAtTime(120,t,0.1);masterHPF.Q.setTargetAtTime(0.7,t,0.1);}
  if(audioOpts.limiter){masterComp.threshold.setTargetAtTime(-6,t,0.05);masterComp.ratio.setTargetAtTime(12,t,0.05);}
  else{masterComp.threshold.setTargetAtTime(-1,t,0.05);masterComp.ratio.setTargetAtTime(1,t,0.05);}
  dlog('Profilo: '+(audioOpts.headphones?'Cuffie':'Altoparlanti')+' · Limiter:'+(audioOpts.limiter?'ON':'OFF'));
}
function resumeAC(){if(AC&&AC.state==='suspended')AC.resume();}
function setMasterVol(v){cfg.vol=v;if(masterGain&&AC)masterGain.gain.setTargetAtTime(v,AC.currentTime,0.1);}

/* ── Synth helpers ── */
function mkOsc(type,freq,gain,detune){
  if(!AC||!masterGain)return null;
  var g=AC.createGain(); g.gain.value=gain; g.connect(masterGain);
  var o=AC.createOscillator(); o.type=type; o.frequency.value=freq;
  if(detune)o.detune.value=detune; o.connect(g); o.start(0);
  var node={osc:o,gain:g}; activeNodes.push(node); return node;
}
function mkNoise(gainVal,filterHz,filterQ){
  if(!AC||!masterGain)return null;
  var len=AC.sampleRate*4,buf=AC.createBuffer(1,len,AC.sampleRate),d=buf.getChannelData(0);
  for(var i=0;i<len;i++)d[i]=Math.random()*2-1;
  var src=AC.createBufferSource(); src.buffer=buf; src.loop=true;
  var filt=AC.createBiquadFilter(); filt.type='lowpass'; filt.frequency.value=filterHz||400; filt.Q.value=filterQ||0.5;
  var g=AC.createGain(); g.gain.value=gainVal;
  src.connect(filt); filt.connect(g); g.connect(masterGain); src.start(0);
  var node={src:src,gain:g,filt:filt}; activeNodes.push(node); return node;
}
function mkLFO(targetNode,rate,depth,base){
  if(!AC||!targetNode)return null; targetNode.gain.gain.value=base;
  var lfo=AC.createOscillator(); lfo.type='sine'; lfo.frequency.value=rate;
  var lg=AC.createGain(); lg.gain.value=depth; lfo.connect(lg); lg.connect(targetNode.gain.gain); lfo.start(0);
  activeNodes.push({osc:lfo,gain:lg}); return lfo;
}
function ringBell(freq,vol){
  if(!AC||!masterGain)return; var t=AC.currentTime;
  var g=AC.createGain(); g.connect(masterGain); g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(vol,t+0.015); g.gain.exponentialRampToValueAtTime(0.0001,t+7);
  [[1,1],[2.756,.5],[5.404,.25],[8.201,.1]].forEach(function(p){var o=AC.createOscillator();o.type='sine';o.frequency.value=freq*p[0];o.connect(g);o.start(t);o.stop(t+7.5);});
}
function startForest(){
  dlog('Foresta'); var p1=mkOsc('sine',55,0.16),p2=mkOsc('sine',82,0.10,3); mkOsc('triangle',110,0.06,-5);
  mkNoise(0.055,260,0.7); mkLFO(p1,0.07,0.05,0.16); mkLFO(p2,0.11,0.03,0.10);
  var notes=[55,65.4,73.4,82,98,110],ni=0;
  function arp(){if(!synthActive)return;var freq=notes[ni++%notes.length];var n=mkOsc('sine',freq,0);if(n){n.gain.gain.setValueAtTime(0,AC.currentTime);n.gain.gain.linearRampToValueAtTime(0.055,AC.currentTime+1.5);n.gain.gain.exponentialRampToValueAtTime(0.0001,AC.currentTime+6);synthTimers.push(setTimeout(function(){try{n.osc.stop();}catch(e){}},6500));}synthTimers.push(setTimeout(arp,3500+Math.random()*4500));}
  synthTimers.push(setTimeout(arp,1500));
}
function startCosmos(){
  dlog('Cosmo'); var d1=mkOsc('sine',40,0.18),d2=mkOsc('sine',60,0.12,8); mkOsc('sine',80,0.07,-6); mkOsc('sine',120,0.04,12);
  var s1=mkOsc('sine',320,0.025,0); mkOsc('sine',480,0.015,15);
  mkLFO(d1,0.04,0.06,0.18); mkLFO(d2,0.06,0.04,0.12); if(s1)mkLFO(s1,0.15,0.015,0.025);
}
function startOcean(){
  dlog('Oceano'); var n1=mkNoise(0.20,700,0.4); mkNoise(0.08,110,0.3); mkOsc('sine',42,0.07); mkOsc('sine',56,0.04,5);
  if(n1&&AC){var lfo1=AC.createOscillator();lfo1.type='sine';lfo1.frequency.value=0.10;var lg1=AC.createGain();lg1.gain.value=0.08;lfo1.connect(lg1);lg1.connect(n1.gain.gain);lfo1.start(0);n1.gain.gain.value=0.20;activeNodes.push({osc:lfo1,gain:lg1});var lfo2=AC.createOscillator();lfo2.type='sine';lfo2.frequency.value=0.17;var lg2=AC.createGain();lg2.gain.value=0.035;lfo2.connect(lg2);lg2.connect(n1.gain.gain);lfo2.start(0);activeNodes.push({osc:lfo2,gain:lg2});}
}
function startTemple(){
  dlog('Tempio'); var d1=mkOsc('sine',80,0.09); mkOsc('sine',160,0.04,4); mkNoise(0.012,180,0.5); if(d1)mkLFO(d1,0.05,0.03,0.09);
  var bellFreqs=[196,220,246.9,261.6,293.7,329.6,392,440];
  function bell(){if(!synthActive)return;ringBell(bellFreqs[Math.floor(Math.random()*bellFreqs.length)],0.05+Math.random()*0.04);synthTimers.push(setTimeout(bell,4500+Math.random()*8000));}
  synthTimers.push(setTimeout(bell,600)); synthTimers.push(setTimeout(bell,5000+Math.random()*3000));
}

/* ── MP3 gapless engine (AudioBuffer loop — zero-gap, sample-accurate) ── */
/* Cache decoded buffers so repeat plays skip the fetch/decode step */
var mp3BufferCache = {};
var mp3SourceNode  = null;   /* current AudioBufferSourceNode */
var mp3GainNode    = null;   /* per-track gain for fade-in/out */

function stopMP3(){
  if(!mp3SourceNode) return;
  var src = mp3SourceNode, gn = mp3GainNode;
  mp3SourceNode = null; mp3GainNode = null;
  /* Soft fade-out then stop */
  if(AC && gn){
    gn.gain.setTargetAtTime(0, AC.currentTime, 0.3);
  }
  setTimeout(function(){
    try{ src.stop(); }catch(e){}
    try{ src.disconnect(); }catch(e){}
    if(gn) try{ gn.disconnect(); }catch(e){}
    dlog('MP3 fermato');
  }, 1000);
}

function startMP3(url, onReady){
  stopMP3();
  if(!AC){ dlog('AC non pronto per MP3','error'); return; }
  resumeAC();

  function _play(audioBuffer){
    if(!AC) return;
    /* Create a dedicated gain node for this track (fade-in) */
    var gn = AC.createGain();
    gn.gain.setValueAtTime(0, AC.currentTime);
    gn.gain.linearRampToValueAtTime(cfg.vol, AC.currentTime + 2.5);
    gn.connect(masterGain);

    var src = AC.createBufferSource();
    src.buffer = audioBuffer;
    src.loop   = true;
    /* loopStart/loopEnd = 0 & duration → Web Audio loops the exact sample
       range with zero gap. No ID3 tags, no decoder padding issues. */
    src.loopStart = 0;
    src.loopEnd   = audioBuffer.duration;
    src.connect(gn);
    src.start(0);

    mp3SourceNode = src;
    mp3GainNode   = gn;

    dlog('MP3 gapless avviato: '+url+' ('+audioBuffer.duration.toFixed(2)+'s)','ok');
    if(onReady) onReady('◈ '+TRACKS[cfg.track].name+' · 432 Hz · in ascolto');
  }

  /* Use cached buffer if available */
  if(mp3BufferCache[url]){
    dlog('MP3 buffer cached, avvio immediato');
    _play(mp3BufferCache[url]);
    return;
  }

  /* Fetch + decode → cache → play */
  dlog('MP3 fetch: '+url);
  if(onReady) onReady('⏳ Caricamento traccia 432 Hz…');

  fetch(url)
    .then(function(r){
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.arrayBuffer();
    })
    .then(function(ab){
      return AC.decodeAudioData(ab);
    })
    .then(function(audioBuffer){
      mp3BufferCache[url] = audioBuffer;   /* cache for instant replay */
      _play(audioBuffer);
    })
    .catch(function(e){
      dlog('MP3 load err: '+e.message,'error');
      if(onReady) onReady('⚠ Errore caricamento traccia');
    });
}

/* ── Binaural beat engine (stereo, Safari-safe) ── */
function stopBinaural(){
  if(!binauralNodes||!AC)return;
  try{ binauralNodes.gain.gain.setTargetAtTime(0, AC.currentTime, 0.4); }catch(e){}
  var bn = binauralNodes; binauralNodes = null;
  setTimeout(function(){
    try{bn.left.stop();}catch(e){}
    try{bn.right.stop();}catch(e){}
    try{bn.gain.disconnect();}catch(e){}
    if(bn.panL){try{bn.panL.disconnect();}catch(e){}}
    if(bn.panR){try{bn.panR.disconnect();}catch(e){}}
    dlog('Binaural fermato');
  }, 1200);
}
function startBinaural(mode){
  stopBinaural();
  var b = BINAURAL[mode]; if(!b||b.hz===0||!AC)return;
  var freqL = b.base, freqR = b.base + b.beat;
  var gainB = AC.createGain();
  gainB.gain.setValueAtTime(0, AC.currentTime);
  gainB.gain.linearRampToValueAtTime(0.09, AC.currentTime + 3.5);
  var left  = AC.createOscillator();
  var right = AC.createOscillator();
  left.type  = 'sine'; left.frequency.value  = freqL;
  right.type = 'sine'; right.frequency.value = freqR;
  /* Stereo panning: StereoPannerNode (Safari 15+) or PannerNode fallback */
  var panL=null, panR=null;
  if(AC.createStereoPanner){
    panL = AC.createStereoPanner(); panL.pan.value = -1;
    panR = AC.createStereoPanner(); panR.pan.value =  1;
    left.connect(panL);  panL.connect(gainB);
    right.connect(panR); panR.connect(gainB);
  } else {
    /* Fallback: summed mono (binaural effect lost, but audio works) */
    left.connect(gainB); right.connect(gainB);
    dlog('StereoPanner non disponibile · binaural in mono','warn');
  }
  gainB.connect(AC.destination); /* Direct to destination for pure stereo */
  left.start(0); right.start(0);
  binauralNodes = { left:left, right:right, gain:gainB, panL:panL, panR:panR };
  dlog('Binaural: '+freqL+' Hz (L) · '+freqR+' Hz (R) · beat '+b.beat+' Hz ['+b.name+']','ok');
}

/* ── Main synth start/stop ── */
function stopSynth(){
  synthActive=false; stopBinaural();
  if(customOpts.enabled&&customLoaded){ stopCustomAudioSession(); synthTimers.forEach(function(t){clearTimeout(t);}); synthTimers=[]; return; }
  if(TRACKS[cfg.track]&&!TRACKS[cfg.track].synth){ stopMP3(); synthTimers=[]; return; }
  synthTimers.forEach(function(t){clearTimeout(t);}); synthTimers=[];
  if(masterGain&&AC) masterGain.gain.setTargetAtTime(0, AC.currentTime, 0.35);
  setTimeout(function(){
    activeNodes.forEach(function(n){
      try{if(n.osc)n.osc.stop();}catch(e){}
      try{if(n.src)n.src.stop();}catch(e){}
      try{if(n.gain)n.gain.disconnect();}catch(e){}
      try{if(n.filt)n.filt.disconnect();}catch(e){}
    });
    activeNodes=[];
    if(masterGain&&AC) masterGain.gain.setValueAtTime(cfg.vol, AC.currentTime);
    dlog('Sintesi fermata');
  }, 900);
}
function startSynth(trackId, onReady){
  if(!AC){dlog('AC non disponibile','error');return;}
  /* Custom track override */
  if(customOpts.enabled&&customLoaded){
    synthActive=true; activeNodes=[];
    var ok=startCustomAudioSession(onReady);
    if(!ok&&onReady) onReady('⚠ File non disponibile');
    if(cfg.binaural!=='none') startBinaural(cfg.binaural);
    return;
  }
  resumeAC(); synthActive=true; activeNodes=[];
  var track = TRACKS[trackId];
  /* MP3 real track */
  if(track&&!track.synth){
    startMP3(track.url, function(msg){
      if(cfg.binaural!=='none') startBinaural(cfg.binaural);
      if(onReady) onReady(msg + (cfg.binaural!=='none'?' · '+BINAURAL[cfg.binaural].name:''));
    });
    return;
  }
  /* Synth track */
  masterGain.gain.setValueAtTime(0, AC.currentTime);
  masterGain.gain.linearRampToValueAtTime(cfg.vol, AC.currentTime+2.2);
  if(trackId==='forest') startForest();
  else if(trackId==='cosmos') startCosmos();
  else if(trackId==='ocean') startOcean();
  else if(trackId==='temple') startTemple();
  else startCosmos();
  if(cfg.binaural!=='none') startBinaural(cfg.binaural);
  var bl = cfg.binaural!=='none' ? ' · '+BINAURAL[cfg.binaural].name : '';
  dlog('Avviato: '+(track?track.name:trackId)+bl,'ok');
  if(onReady) onReady('◎ '+(track?track.name:trackId)+bl+' · in ascolto');
}

/* ── Visibility / touchstart ── */
document.addEventListener('visibilitychange',function(){
  if(!document.hidden){
    if(AC&&AC.state==='suspended') AC.resume().then(function(){dlog('AC resumed');});
    if(sess.timer){
      if(customOpts.enabled&&customLoaded){ if(customAudio&&customAudio.paused){customAudio.play().catch(function(){});dlog('Traccia ripresa');} }
      else if(!synthActive){ dlog('Riavvio sintesi','ok'); startSynth(cfg.track,function(msg){var tt=qs('tickerText');if(tt)tt.textContent=msg;}); }
    }
  }
});
document.addEventListener('touchstart',function(){if(AC&&AC.state==='suspended')AC.resume();},{passive:true});

/* ══ PREVIEW ══ */
var prevTimer=null,prevIdx=0,prevElapsed=0;
function fillType(n){if(n==='Inspira')return'top';if(n==='Trattieni'||n==='Pausa')return'ltr';return'bottom';}
function buildPreview(patId){
  var p=PATTERNS[patId],w=qs('previewBars'); w.innerHTML='';
  p.phases.forEach(function(ph,i){
    var col=mkEl('div','prev-col'); col.id='pv'+i;
    var tr=mkEl('div','prev-track'); var ft=fillType(ph.n);
    var fi=mkEl('div','prev-fill'+(ft==='top'?' fill-top':ft==='ltr'?' fill-ltr':'')); fi.id='pvf'+i; fi.style.background=PC[ph.n]||'#c8a26a';
    var cr=mkEl('div','prev-count-row'); var nu=mkEl('div','prev-num'); nu.id='pvn'+i; nu.textContent=ph.d; var sl=mkEl('div','prev-sec-lbl'); sl.textContent='s'; cr.appendChild(nu); cr.appendChild(sl);
    var nm=mkEl('div','prev-name'); nm.textContent=ph.n;
    tr.appendChild(fi); col.appendChild(tr); col.appendChild(cr); col.appendChild(nm); w.appendChild(col);
  });
  prevIdx=0; prevElapsed=0; if(prevTimer)clearInterval(prevTimer); prevTimer=setInterval(tickPrev,1000); renderPrev();
}
function tickPrev(){var p=PATTERNS[cfg.pattern],ph=p.phases[prevIdx]; prevElapsed++; if(prevElapsed>=ph.d){prevElapsed=0;prevIdx=(prevIdx+1)%p.phases.length;} renderPrev();}
function renderPrev(){
  var p=PATTERNS[cfg.pattern];
  p.phases.forEach(function(ph,i){
    var f=document.getElementById('pvf'+i),nu=document.getElementById('pvn'+i); if(!f)return;
    var a=i===prevIdx,pct=a?(prevElapsed/ph.d)*100:0,ft=fillType(ph.n);
    if(nu){nu.textContent=a?(ph.d-prevElapsed):ph.d;nu.className='prev-num'+(a?' active-num':'');}
    if(ft==='ltr'){f.style.width=a?pct+'%':'0%';f.style.opacity=a?'1':'0.18';}
    else{f.style.height=a?pct+'%':'0%';f.style.opacity=a?'1':'0.18';}
  });
}

/* ══ UI INTERACTIONS ══ */
qsa('.pattern-card').forEach(function(c){
  c.addEventListener('click',function(){
    qsa('.pattern-card').forEach(function(x){x.classList.remove('active');});
    c.classList.add('active'); cfg.pattern=c.dataset.id;
    buildPreview(cfg.pattern);
    updateRecommendations();
    /* c) Auto-apply matching EQ preset */
    if(EQ_PRESETS[cfg.pattern]){
      applyEQPreset(cfg.pattern, true);
      dlog('EQ auto-preset → '+cfg.pattern);
    }
  });
});
qsa('.dur-pill').forEach(function(p){p.addEventListener('click',function(){qsa('.dur-pill').forEach(function(x){x.classList.remove('active');});p.classList.add('active');cfg.minutes=parseInt(p.dataset.min);});});
qsa('.track-card').forEach(function(c){c.addEventListener('click',function(){qsa('.track-card').forEach(function(x){x.classList.remove('active');});c.classList.add('active');cfg.track=c.dataset.tid;});});
qsa('.binaural-card').forEach(function(c){c.addEventListener('click',function(){qsa('.binaural-card').forEach(function(x){x.classList.remove('active');});c.classList.add('active');cfg.binaural=c.dataset.bid;});});
qs('volSetup').addEventListener('input',function(e){setMasterVol(parseFloat(e.target.value));});
qs('sessVol').addEventListener('input',function(e){setMasterVol(parseFloat(e.target.value));});

qs('saveBtn').addEventListener('click',function(){
  var ok=saveSettings(),btn=qs('saveBtn');
  if(ok){btn.classList.add('saved');btn.innerHTML='<span class="save-icon">✓</span> Impostazioni salvate';dlog('Salvato','ok');setTimeout(function(){btn.classList.remove('saved');btn.innerHTML='<span class="save-icon">↓</span> Salva impostazioni';},2200);}
});

/* ══ SESSIONE ══ */
qs('startBtn').addEventListener('click',function(){if(!initAC())return;startSession();});
function startSession(){
  if(prevTimer){clearInterval(prevTimer);prevTimer=null;}
  var p=PATTERNS[cfg.pattern],t=TRACKS[cfg.track];
  sess.total=cfg.minutes*60; sess.elapsed=0; sess.phIdx=0; sess.phElapsed=0; sess.cycles=0;
  qs('sessPatLabel').textContent=p.name;
  qs('sessTrackLabel').textContent=t.name+(cfg.binaural!=='none'?' · '+BINAURAL[cfg.binaural].name:'');
  var si=qs('sessSoundIcon'); if(si) si.textContent=t.icon;
  var pn=qs('sessPatternName'); if(pn) pn.textContent=p.name;
  var pt=qs('sessPatternText'); if(pt) pt.textContent=p.desc;
  var ps=qs('sessPatternSteps'); if(ps){ps.innerHTML='';p.steps.forEach(function(s){var sp=document.createElement('span');sp.className='sess-pattern-step';sp.textContent=s;ps.appendChild(sp);});}
  qs('sessVol').value=cfg.vol;
  qs('orb1').style.background=p.color; qs('orb2').style.background=t.color;
  buildSessionBars(p); showScreen('session'); showDebugToggle(true);
  qs('tickerDot').style.background=t.color;
  startSynth(cfg.track,function(msg){qs('tickerText').textContent=msg;});
  tick(); sess.timer=setInterval(tick,1000);
}
function sFT(n){if(n==='Inspira')return'top';if(n==='Trattieni'||n==='Pausa')return'ltr';return'bottom';}
function buildSessionBars(p){
  var w=qs('breathBars'); w.innerHTML='';
  p.phases.forEach(function(ph,i){
    var col=mkEl('div','bar-col'+(i===0?' cur':'')); col.id='bc'+i;
    var tr=mkEl('div','bar-track'+(i===0?' cur':'')); tr.id='bt'+i;
    var ft=sFT(ph.n),fi=mkEl('div','bar-fill'+(ft==='top'?' top-fill':ft==='ltr'?' ltr-fill':'')); fi.id='bf'+i;
    var c=PC[ph.n]||'#c8a26a'; fi.style.background='linear-gradient(180deg,'+c+' 0%,'+rgba(c,.5)+' 100%)';
    var lb=mkEl('div','bar-lbl'); lb.textContent=ph.n;
    tr.appendChild(fi); col.appendChild(tr); col.appendChild(lb); w.appendChild(col);
  });
}
function tick(){
  resumeAC(); var p=PATTERNS[cfg.pattern],ph=p.phases[sess.phIdx];
  sess.elapsed++; sess.phElapsed++; updateSessionUI();
  if(sess.elapsed>=sess.total){endSession();return;}
  if(sess.phElapsed>=ph.d){sess.phElapsed=0;sess.phIdx=(sess.phIdx+1)%p.phases.length;if(sess.phIdx===0)sess.cycles++;}
}
function updateSessionUI(){
  var p=PATTERNS[cfg.pattern],ph=p.phases[sess.phIdx];
  var pPr=sess.phElapsed/ph.d,sPr=sess.elapsed/sess.total,col=PC[ph.n]||p.color;
  qs('countNum').textContent=sess.phElapsed; qs('countNum').style.color=col;
  qs('phaseLbl').textContent=ph.n.toUpperCase(); qs('phaseLbl').style.color=col;
  qs('orb1').style.background=col;
  p.phases.forEach(function(phase,i){
    var bc=document.getElementById('bc'+i),bt=document.getElementById('bt'+i),bf=document.getElementById('bf'+i);
    if(!bc||!bt||!bf)return; var cur=i===sess.phIdx;
    bc.classList.toggle('cur',cur); bt.classList.toggle('cur',cur);
    var ft=sFT(phase.n);
    if(ft==='ltr'){bf.style.height='100%';bf.style.width=cur?(pPr*100)+'%':'0%';bf.style.opacity=cur?'1':'0.14';}
    else{bf.style.width='100%';bf.style.height=cur?(pPr*100)+'%':'0%';bf.style.opacity=cur?'1':'0.14';}
  });
  qs('progFill').style.width=(sPr*100)+'%';
  var left=sess.total-sess.elapsed; qs('progTime').textContent=Math.floor(left/60)+':'+String(left%60).padStart(2,'0')+' rimasti';
}
function endSession(){clearInterval(sess.timer);sess.timer=null;stopSynth();showDebugToggle(false);qs('statMin').textContent=cfg.minutes;qs('statCycles').textContent=sess.cycles;qs('statTrack').textContent=TRACKS[cfg.track].name;showScreen('end');}
qs('closeBtn').addEventListener('click',function(){clearInterval(sess.timer);sess.timer=null;stopSynth();showDebugToggle(false);showScreen('setup');setTimeout(function(){buildPreview(cfg.pattern);},120);});
qs('againBtn').addEventListener('click',function(){showScreen('setup');setTimeout(function(){buildPreview(cfg.pattern);},120);});

/* ══ UTILS ══ */
function showScreen(id){qsa('.screen').forEach(function(s){s.classList.add('hidden');});document.getElementById(id).classList.remove('hidden');}
function qsa(sel){return Array.from(document.querySelectorAll(sel));}
function qs(id){return document.getElementById(id);}
function mkEl(tag,cls){var e=document.createElement(tag);e.className=cls;return e;}
function rgba(hex,a){var r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return'rgba('+r+','+g+','+b+','+a.toFixed(2)+')';}

document.addEventListener('touchmove',function(e){
  if(!e.target.closest('#setup')&&!e.target.closest('input[type=range]')&&!e.target.closest('.panel-scroll')&&!e.target.closest('.guide-body')&&!e.target.closest('.debug-log'))e.preventDefault();
},{passive:false});

/* ══ TEMA ══ */
var currentTheme='dark';
function applyTheme(theme){
  currentTheme=theme;
  var root=document.documentElement,meta=document.querySelector('meta[name="theme-color"]');
  if(theme==='light'){root.classList.add('light');if(meta)meta.setAttribute('content','#f5f0e8');}
  else{root.classList.remove('light');if(meta)meta.setAttribute('content','#080705');}
  document.body.style.backgroundColor=theme==='light'?'#f5f0e8':'#080705';
  qsa('.screen').forEach(function(s){s.style.backgroundColor=theme==='light'?'#f5f0e8':'#080705';});
  setPanelColors(theme);
  var swTh=qs('swTheme'); if(swTh){swTh.classList.toggle('on',theme==='light');swTh.setAttribute('aria-checked',theme==='light'?'true':'false');}
  /* Update swTheme label dynamically */
  var lbl=qs('swThemeLabel'), dsc=qs('swThemeDesc');
  if(lbl) lbl.textContent = theme==='light' ? 'Tema Chiaro' : 'Tema Scuro';
  if(dsc) dsc.textContent = theme==='light' ? 'Attiva per tornare alla modalità scura.' : 'Attiva per passare alla modalità chiara.';
  /* Update header theme button */
  var tIcon=qs('themeBtnIcon'), tLbl=qs('themeBtnLabel');
  if(tIcon) tIcon.textContent = theme==='light' ? '◐' : '◑';
  if(tLbl)  tLbl.innerHTML  = theme==='light' ? 'TEMA<br>CHIARO' : 'TEMA<br>SCURO';
  try{localStorage.setItem(THEME_KEY,theme);}catch(e){}
}
(function(){
  var saved; try{saved=localStorage.getItem(THEME_KEY);}catch(e){}
  if(!saved)saved=(window.matchMedia&&window.matchMedia('(prefers-color-scheme: light)').matches)?'light':'dark';
  applyTheme(saved);
})();
if(window.matchMedia){window.matchMedia('(prefers-color-scheme: light)').addEventListener('change',function(e){var saved;try{saved=localStorage.getItem(THEME_KEY);}catch(ex){}if(!saved)applyTheme(e.matches?'light':'dark');});}

/* ══ SETTINGS PANEL ══ */
function swSet(id,on){var el=qs(id);if(!el)return;el.classList.toggle('on',on);el.setAttribute('aria-checked',on?'true':'false');}
function swToggle(id,callback){var el=qs(id);if(!el)return;var next=!el.classList.contains('on');swSet(id,next);callback(next);saveAllSettings();}
qs('swHeadphones').addEventListener('click',function(){swToggle('swHeadphones',function(on){audioOpts.headphones=on;applyAudioProfile();dlog('Modalità: '+(on?'Cuffie':'Altoparlanti'));});});
qs('swLimiter').addEventListener('click',function(){swToggle('swLimiter',function(on){audioOpts.limiter=on;applyAudioProfile();dlog('Limiter: '+(on?'ON':'OFF'));});});
qs('swTheme').addEventListener('click',function(){
  var next=!this.classList.contains('on');
  applyTheme(next?'light':'dark');
});

/* Header theme button */
(function(){
  var btn=qs('themeBtnHeader'); if(!btn)return;
  btn.addEventListener('click',function(){
    applyTheme(currentTheme==='dark'?'light':'dark');
  });
})();

/* Guide panel */
function openGuide(){ openPanel('guidePanel'); }
function closeGuide(){ closePanel('guidePanel'); }
(function(){
  var btn=qs('guideBtnHeader'); if(btn) btn.addEventListener('click', openGuide);
  var cl=qs('guideClose'); if(cl) cl.addEventListener('click', closeGuide);
})();

function openSettings(){
  swSet('swHeadphones',audioOpts.headphones);
  swSet('swLimiter',audioOpts.limiter);
  swSet('swTheme',currentTheme==='light');
  swSet('swCustomTrack',customOpts.enabled);
  updateCustomTrackUI();
  /* Sync EQ preset buttons */
  qsa('.eq-preset-btn').forEach(function(b){ b.classList.toggle('active', b.dataset.preset===currentEqPreset); });
  /* Re-sync theme toggle label (in case it got out of sync) */
  var lbl=qs('swThemeLabel'),dsc=qs('swThemeDesc');
  if(lbl) lbl.textContent = currentTheme==='light'?'Tema Chiaro':'Tema Scuro';
  if(dsc) dsc.textContent = currentTheme==='light'?'Attiva per tornare alla modalità scura.':'Attiva per passare alla modalità chiara.';
  openPanel('settingsPanel');
}
function closeSettings(){closePanel('settingsPanel');}
qs('gearBtn').addEventListener('click',openSettings);
qs('gearBtnSession').addEventListener('click',openSettings);
qs('settingsClose').addEventListener('click',closeSettings);

/* ══ TRACCIA PERSONALE — IndexedDB ══ */
var customObjectURL=null,customAudio=null,customMediaNode=null,customLoaded=false;
var IDB_NAME='respiraDB',IDB_VER=1,IDB_STORE='audioFiles';
function idbOpen(cb){var req=indexedDB.open(IDB_NAME,IDB_VER);req.onupgradeneeded=function(e){var db=e.target.result;if(!db.objectStoreNames.contains(IDB_STORE))db.createObjectStore(IDB_STORE,{keyPath:'id'});};req.onsuccess=function(e){cb(null,e.target.result);};req.onerror=function(e){cb(e.target.error,null);};}
function idbSave(name,blob,done){idbOpen(function(err,db){if(err){dlog('IDB save err: '+err,'error');if(done)done(false);return;}var tx=db.transaction(IDB_STORE,'readwrite');tx.objectStore(IDB_STORE).put({id:'customTrack',name:name,blob:blob});tx.oncomplete=function(){db.close();dlog('IDB salvato: '+name,'ok');if(done)done(true);};tx.onerror=function(){db.close();dlog('IDB write err','error');if(done)done(false);};});}
function idbLoad(done){idbOpen(function(err,db){if(err){if(done)done(null);return;}var req=db.transaction(IDB_STORE,'readonly').objectStore(IDB_STORE).get('customTrack');req.onsuccess=function(e){db.close();if(done)done(e.target.result||null);};req.onerror=function(){db.close();if(done)done(null);};});}
function idbDelete(done){idbOpen(function(err,db){if(err){if(done)done();return;}var tx=db.transaction(IDB_STORE,'readwrite');tx.objectStore(IDB_STORE).delete('customTrack');tx.oncomplete=function(){db.close();dlog('IDB rimosso');if(done)done();};tx.onerror=function(){db.close();if(done)done();};});}
function idbRestoreOnStartup(){idbLoad(function(rec){if(!rec)return;dlog('IDB trovato: '+rec.name,'ok');applyBlob(rec.blob,rec.name);updateCustomTrackUI();swSet('swCustomTrack',customOpts.enabled);});}
function applyBlob(blob,name){if(customObjectURL)URL.revokeObjectURL(customObjectURL);customObjectURL=URL.createObjectURL(blob);customOpts.fileName=name;customLoaded=true;showCtLoaded(name,blob.size);buildPreviewPlayer(customObjectURL);}
function showCtEmpty(){qs('ctEmpty').style.display='';qs('ctLoaded').style.display='none';var pb=qs('customPlayBtn');if(pb){pb.textContent='▶';pb.classList.remove('playing');}}
function showCtLoaded(name,size){qs('ctEmpty').style.display='none';qs('ctLoaded').style.display='';qs('ctFileName').textContent=name;var meta='';if(size){if(size>1048576)meta=(size/1048576).toFixed(1)+' MB';else meta=Math.round(size/1024)+' KB';}qs('ctFileMeta').textContent=meta||'file audio';}
qs('swCustomTrack').addEventListener('click',function(){swToggle('swCustomTrack',function(on){customOpts.enabled=on;updateCustomTrackUI();saveAllSettings();dlog('Traccia personale: '+(on?'ON':'OFF'));});});
function updateCustomTrackUI(){qs('customTrackArea').classList.toggle('disabled',!customOpts.enabled);}
qs('customFileInput').addEventListener('change',function(e){var f=e.target.files&&e.target.files[0];if(f)loadCustomFile(f);this.value='';});
qs('ctChangeBtn').addEventListener('click',function(){qs('customFileInput').click();});
qs('customUrlBtn').addEventListener('click',function(){loadCustomUrl();});
qs('customUrlInput').addEventListener('keydown',function(e){if(e.key==='Enter'){this.blur();loadCustomUrl();}});
qs('customUrlInput').addEventListener('focus',function(){var el=this;setTimeout(function(){el.scrollIntoView({behavior:'smooth',block:'center'});},350);});
function loadCustomUrl(){
  var url=(qs('customUrlInput').value||'').trim(); if(!url)return;
  if(!/^https?:\/\//i.test(url)){qs('customUrlInput').style.borderColor='rgba(176,122,138,.6)';setTimeout(function(){qs('customUrlInput').style.borderColor='';},1500);return;}
  var btn=qs('customUrlBtn'); btn.textContent='…'; btn.disabled=true;
  fetch(url).then(function(r){if(!r.ok)throw new Error('HTTP '+r.status);return r.blob();}).then(function(blob){var parts=url.split('/'),name=decodeURIComponent(parts[parts.length-1].split('?')[0])||'traccia.mp3';idbSave(name,blob,function(ok){btn.textContent='Carica';btn.disabled=false;if(ok){applyBlob(blob,name);qs('customUrlInput').value='';}else dlog('Errore save URL','error');});}).catch(function(e){btn.textContent='Carica';btn.disabled=false;dlog('Fetch err: '+e.message,'error');qs('customUrlInput').style.borderColor='rgba(176,122,138,.6)';setTimeout(function(){qs('customUrlInput').style.borderColor='';},2000);});
}
function loadCustomFile(file){destroyCustomAudio();var lbl=document.querySelector('.ct-pick-main');if(lbl)lbl.textContent='Salvataggio…';idbSave(file.name,file,function(ok){if(lbl)lbl.textContent='Scegli dal dispositivo';if(ok)applyBlob(file,file.name);else dlog('Errore save file','error');});}
function buildPreviewPlayer(src){if(customAudio){customAudio.pause();customAudio.src='';}customAudio=new Audio(src);customAudio.loop=true;customAudio.preload='metadata';customAudio.addEventListener('timeupdate',onCustomProgress);customAudio.addEventListener('loadedmetadata',onCustomProgress);}
function onCustomProgress(){if(!customAudio)return;var pct=customAudio.duration?(customAudio.currentTime/customAudio.duration)*100:0,s=Math.floor(customAudio.currentTime),el=qs('customProgress'),tm=qs('customTime');if(el)el.style.width=pct+'%';if(tm)tm.textContent=Math.floor(s/60)+':'+String(s%60).padStart(2,'0');}
qs('customPlayBtn').addEventListener('click',function(){if(!customAudio)return;if(customAudio.paused){customAudio.play();this.textContent='⏸';this.classList.add('playing');}else{customAudio.pause();this.textContent='▶';this.classList.remove('playing');}});
qs('customRemove').addEventListener('click',function(){destroyCustomAudio();if(customObjectURL){URL.revokeObjectURL(customObjectURL);customObjectURL=null;}customLoaded=false;customOpts.fileName=null;idbDelete();showCtEmpty();dlog('Traccia rimossa');});
function destroyCustomAudio(){if(customAudio){customAudio.pause();customAudio.removeEventListener('timeupdate',onCustomProgress);customAudio.removeEventListener('loadedmetadata',onCustomProgress);customAudio.src='';customAudio=null;}if(customMediaNode){try{customMediaNode.disconnect();}catch(e){}customMediaNode=null;}}
function startCustomAudioSession(onReady){
  if(!customLoaded||!customObjectURL){dlog('Nessun file','warn');return false;}
  if(!AC){dlog('AC non pronto','error');return false;}
  resumeAC();
  if(customAudio&&!customAudio.paused){customAudio.pause();var pb=qs('customPlayBtn');if(pb){pb.textContent='▶';pb.classList.remove('playing');}}
  destroyCustomAudio();
  var sa=new Audio(customObjectURL); sa.loop=true; customAudio=sa;
  customMediaNode=AC.createMediaElementSource(sa); customMediaNode.connect(masterGain); sa.volume=0;
  sa.play().then(function(){var steps=20,step=0,vol=Math.min(cfg.vol,1);var fi=setInterval(function(){step++;sa.volume=Math.min((step/steps)*vol,1);if(step>=steps)clearInterval(fi);},100);dlog('Traccia avviata: '+customOpts.fileName,'ok');if(onReady)onReady('♫ '+customOpts.fileName+' · in riproduzione');}).catch(function(e){dlog('Play err: '+e.message,'error');});
  return true;
}
function stopCustomAudioSession(){if(!customAudio)return;var audio=customAudio,steps=10,step=0,sv=audio.volume;var fi=setInterval(function(){step++;audio.volume=Math.max(sv*(1-step/steps),0);if(step>=steps){clearInterval(fi);audio.pause();audio.currentTime=0;if(customMediaNode){try{customMediaNode.disconnect();}catch(e){}customMediaNode=null;}if(customObjectURL)buildPreviewPlayer(customObjectURL);}},80);}

/* ══ INIT ══ */
dlog('App inizializzata · Web Audio API v2 · EQ 4 bande · Binaural + MP3 gapless');
loadEQ();
var hadSaved=loadSettings();
if(hadSaved)dlog('Impostazioni ripristinate','ok');
loadAllSettings();
applySettingsToUI();
buildPreview(cfg.pattern);
idbRestoreOnStartup();
setPanelColors(currentTheme);
buildEQUI();
wireEQButtons();
/* Apply loaded EQ gains to faders */
EQ_BANDS_DEF.forEach(function(_,i){ setFaderUI(i,eqGains[i],false); });
qsa('.eq-preset-btn').forEach(function(b){ b.classList.toggle('active', b.dataset.preset===currentEqPreset); });
/* If no saved EQ exists, set preset matching the loaded pattern */
(function(){
  try{ if(localStorage.getItem('respira_eq_v1')) return; }catch(e){}
  if(EQ_PRESETS[cfg.pattern]){
    applyEQPreset(cfg.pattern, false);
  }
})();
</script>
</body>
</html>
